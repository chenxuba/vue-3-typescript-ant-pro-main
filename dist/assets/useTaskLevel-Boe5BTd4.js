import{d as J,_ as P,a1 as R,$ as x,a6 as B,a7 as w,k as C,a9 as G,B as Fe,u as z,F as te,G as O,f as L,y as Te,w as se,n as xe,ag as ce,an as $e,ac as ie,ab as Ie,c as Y,l as ae}from"./vue-PnzzEkKE.js";import{ad as Ae,ak as Se,D as qe,u as Le,f as Ve,e as Me,c as Re,H as Z,K as le,z as oe,I as re,M as H,al as Ue,am as Ne,ab as De,ah as Ke,a1 as p}from"./antd-Cme2pY03.js";import{_ as W}from"./index-DmgcJQeo.js";import{R as Ee,u as Pe}from"./RichTextEditor-Bq9HNmhi.js";import{h as de,i as Oe,j as Qe,k as je,l as Be,m as He,b as ue,d as ze}from"./index-BNK75F8N.js";const Ge={class:"file-tree-container"},Je={class:"tree-content"},We={class:"tree-node-title-wrapper"},Xe={class:"tree-node-title"},Ye={key:0,class:"folder-icon"},Ze={key:1,class:"file-icon"},et=["title"],tt=J({__name:"FileTreeComponent",props:{fileTreeData:{},expandedKeys:{}},emits:["update:expandedKeys","select","menu-click","expand"],setup(_,{emit:v}){const l=v,I=y=>{l("update:expandedKeys",y)},d=(y,r)=>{l("select",y,r)},s=(y,r)=>{l("menu-click",y,r)},g=(y,r)=>{l("expand",y,r)};return(y,r)=>{const h=Ae,k=Me,N=Re,K=Ve,Q=qe,S=Se;return R(),P("div",Ge,[r[10]||(r[10]=x("div",{class:"tree-header"},[x("span",{class:"tree-title"},"文件目录")],-1)),x("div",Je,[!y.fileTreeData||y.fileTreeData.length===0?(R(),B(h,{key:0,description:"暂无文件",class:"empty-tree"},{image:w(()=>r[1]||(r[1]=[x("div",{class:"empty-icon"},"📂",-1)])),_:1})):(R(),B(S,{key:1,"expanded-keys":y.expandedKeys,"onUpdate:expandedKeys":I,"tree-data":y.fileTreeData,"show-icon":!1,"show-line":!0,onSelect:d,onExpand:g},{title:w(({title:F,isLeaf:V,children:E,key:j})=>[x("span",We,[x("span",Xe,[E!==void 0||V===!1?(R(),P("span",Ye,"📁")):(R(),P("span",Ze,"📄")),x("span",{class:"tree-node-text",title:F},G(F),9,et)]),C(Q,{trigger:["click"],placement:"bottomRight"},{overlay:w(()=>[C(K,{onClick:n=>s(n,{key:j,title:F,isLeaf:V,children:E})},{default:w(()=>[E!==void 0||V===!1?(R(),P(te,{key:0},[C(k,{key:"newFile"},{default:w(()=>r[2]||(r[2]=[x("span",null,"新建文件",-1)])),_:1,__:[2]}),C(k,{key:"newFolder"},{default:w(()=>r[3]||(r[3]=[x("span",null,"新建文件夹",-1)])),_:1,__:[3]}),C(k,{key:"upload"},{default:w(()=>r[4]||(r[4]=[x("span",null,"上传",-1)])),_:1,__:[4]}),C(N),C(k,{key:"copyPath"},{default:w(()=>r[5]||(r[5]=[x("span",null,"复制路径",-1)])),_:1,__:[5]}),C(k,{key:"delete",danger:""},{default:w(()=>r[6]||(r[6]=[x("span",null,"删除",-1)])),_:1,__:[6]})],64)):(R(),P(te,{key:1},[C(k,{key:"rename"},{default:w(()=>r[7]||(r[7]=[x("span",null,"重命名",-1)])),_:1,__:[7]}),C(k,{key:"copyPath"},{default:w(()=>r[8]||(r[8]=[x("span",null,"复制路径",-1)])),_:1,__:[8]}),C(k,{key:"delete",danger:""},{default:w(()=>r[9]||(r[9]=[x("span",null,"删除",-1)])),_:1,__:[9]})],64))]),_:2},1032,["onClick"])]),default:w(()=>[x("span",{class:"tree-node-more",onClick:r[0]||(r[0]=Fe(()=>{},["stop"]))},[C(z(Le))])]),_:2},1024)])]),_:1},8,["expanded-keys","tree-data"]))])])}}}),Lt=W(tt,[["__scopeId","data-v-5b6e9659"]]),st={class:"file-preview-area"},nt={key:0,class:"file-preview"},at={class:"file-header"},lt={class:"file-name"},ot={class:"file-content"},rt={class:"download-container"},it={key:1,class:"empty-preview"},ut=J({__name:"FilePreview",props:{selectedFile:{},highlightedCode:{},dynamicFileContents:{}},setup(_){const v=_,l=()=>{var s;const d=v.selectedFile;if(d){if(d.fileUrl){const g=`http://101.200.13.193${d.fileUrl}`,y=document.createElement("a");y.href=g,y.download=d.title,y.target="_blank",document.body.appendChild(y),y.click(),document.body.removeChild(y),console.log("下载文件:",g)}else if(d.content||v.dynamicFileContents&&v.dynamicFileContents[d.key]){const g=d.content||((s=v.dynamicFileContents)==null?void 0:s[d.key])||"",y=new Blob([g],{type:"text/plain;charset=utf-8"}),r=URL.createObjectURL(y),h=document.createElement("a");h.href=r,h.download=d.title,document.body.appendChild(h),h.click(),document.body.removeChild(h),URL.revokeObjectURL(r),console.log("下载本地文件:",d.title)}}},I=()=>{const d=v.selectedFile;return d?!!(d.fileUrl||d.content||v.dynamicFileContents&&v.dynamicFileContents[d.key]):!1};return(d,s)=>{const g=Z;return R(),P("div",st,[d.selectedFile?(R(),P("div",nt,[x("div",at,[s[0]||(s[0]=x("span",{class:"file-icon"},"📄",-1)),x("span",lt,G(d.selectedFile.title),1)]),x("div",ot,[x("div",rt,[C(g,{type:"primary",size:"large",disabled:!I(),onClick:l},{default:w(()=>s[1]||(s[1]=[O(" 点击下载 ")])),_:1,__:[1]},8,["disabled"])])])])):(R(),P("div",it," 在左侧代码仓库区域点击目录打开文件 "))])}}}),Vt=W(ut,[["__scopeId","data-v-8acd7451"]]);function ct(){const _=L([1]);return{codeLineNumbers:_,updateLineNumbers:d=>{const s=d.split(`
`).length;_.value=Array.from({length:Math.max(s,1)},(g,y)=>y+1)},syncScroll:d=>{var y;const s=d.target,g=(y=s.parentElement)==null?void 0:y.querySelector(".code-editor-line-numbers");g&&(g.scrollTop=s.scrollTop)},handleKeydown:(d,s,g)=>{if(d.key==="Tab"){d.preventDefault();const y=d.target,r=y.selectionStart,h=y.selectionEnd,k=s,N=k.substring(0,r)+"  "+k.substring(h);g(N),Te(()=>{y.selectionStart=y.selectionEnd=r+2})}}}}const dt={class:"min-w-100px max-w-150px"},pt={class:"code-editor-wrapper"},mt={class:"code-editor-line-numbers"},ft={class:"modal-footer"},vt=J({__name:"NewFileModal",props:{open:{type:Boolean},parentPath:{}},emits:["update:open","confirm"],setup(_,{emit:v}){const l=_,I=v,d=L(),s=L({fileName:"",commitMessage:"",fileContent:""}),g={fileName:[{required:!0,message:"请输入文件名称",trigger:"blur"}],commitMessage:[{required:!0,message:"请输入提交信息",trigger:"blur"}],fileContent:[{required:!0,message:"请输入文件内容",trigger:"blur"}]},{codeLineNumbers:y,updateLineNumbers:r,syncScroll:h,handleKeydown:k}=ct();se(()=>s.value.fileContent,S=>{r(S)});const N=()=>{var S;I("update:open",!1),(S=d.value)==null||S.resetFields()},K=async()=>{var S,F;try{await((S=d.value)==null?void 0:S.validate()),I("confirm",{...s.value}),(F=d.value)==null||F.resetFields()}catch(V){console.error("表单验证失败：",V)}},Q=S=>{k(S,s.value.fileContent,F=>{s.value.fileContent=F})};return se(()=>l.open,S=>{var F;S&&(s.value={fileName:"",commitMessage:"",fileContent:""},y.value=[1],(F=d.value)==null||F.clearValidate())}),(S,F)=>{const V=re,E=oe,j=le,n=Z,t=H;return R(),B(t,{open:S.open,title:"新建文件",footer:null,width:"880px",centered:"","onUpdate:open":F[4]||(F[4]=i=>S.$emit("update:open",i))},{default:w(()=>[C(j,{ref_key:"formRef",ref:d,model:s.value,rules:g,layout:"vertical"},{default:w(()=>[C(E,{label:"文件名称或文件路径：",name:"fileName",required:""},{default:w(()=>[C(V,{value:s.value.fileName,"onUpdate:value":F[0]||(F[0]=i=>s.value.fileName=i),placeholder:"请输入文件名称"},{addonBefore:w(()=>[x("div",dt,G(S.parentPath),1)]),_:1},8,["value"])]),_:1}),C(E,{label:"提交信息：",name:"commitMessage",required:""},{default:w(()=>[C(V,{value:s.value.commitMessage,"onUpdate:value":F[1]||(F[1]=i=>s.value.commitMessage=i),placeholder:"请输入本次提交的主要信息，合理的描信息有利于代历史记录的查理"},null,8,["value"])]),_:1}),C(E,{label:"文件内容：",name:"fileContent",required:""},{default:w(()=>[x("div",pt,[x("div",mt,[(R(!0),P(te,null,ce(z(y),i=>(R(),P("div",{key:i,class:"line-number"},G(i),1))),128))]),xe(x("textarea",{"onUpdate:modelValue":F[2]||(F[2]=i=>s.value.fileContent=i),class:"code-editor-textarea",placeholder:"请输入文件内容",onScroll:F[3]||(F[3]=(...i)=>z(h)&&z(h)(...i)),onKeydown:Q,spellcheck:"false"},null,544),[[$e,s.value.fileContent]])])]),_:1})]),_:1},8,["model"]),x("div",ft,[C(n,{onClick:N},{default:w(()=>F[5]||(F[5]=[O("取消")])),_:1,__:[5]}),C(n,{type:"primary",onClick:K},{default:w(()=>F[6]||(F[6]=[O("确定")])),_:1,__:[6]})])]),_:1},8,["open"])}}}),Mt=W(vt,[["__scopeId","data-v-8bf29398"]]),gt={class:"min-w-100px max-w-150px"},yt={class:"modal-footer"},_t=J({__name:"NewFolderModal",props:{open:{type:Boolean},parentPath:{}},emits:["update:open","confirm"],setup(_,{emit:v}){const l=_,I=v,d=L(),s=L({folderName:"",commitMessage:""}),g={folderName:[{required:!0,message:"请输入文件夹名称",trigger:"blur"}],commitMessage:[{required:!0,message:"请输入提交信息",trigger:"blur"}]},y=()=>{var h;I("update:open",!1),(h=d.value)==null||h.resetFields()},r=async()=>{var h,k;try{await((h=d.value)==null?void 0:h.validate()),I("confirm",{...s.value}),(k=d.value)==null||k.resetFields()}catch(N){console.error("表单验证失败：",N)}};return se(()=>l.open,h=>{var k;h&&(s.value={folderName:"",commitMessage:""},(k=d.value)==null||k.clearValidate())}),(h,k)=>{const N=re,K=oe,Q=le,S=Z,F=H;return R(),B(F,{open:h.open,title:"新建文件夹",footer:null,width:"600px",centered:"","onUpdate:open":k[2]||(k[2]=V=>h.$emit("update:open",V))},{default:w(()=>[C(Q,{ref_key:"formRef",ref:d,model:s.value,rules:g,layout:"vertical"},{default:w(()=>[C(K,{label:"文件夹名称：",name:"folderName",required:""},{default:w(()=>[C(N,{value:s.value.folderName,"onUpdate:value":k[0]||(k[0]=V=>s.value.folderName=V),placeholder:"请输入文件夹名称"},{addonBefore:w(()=>[x("div",gt,G(h.parentPath),1)]),_:1},8,["value"])]),_:1}),C(K,{label:"提交信息：",name:"commitMessage",required:""},{default:w(()=>[C(N,{value:s.value.commitMessage,"onUpdate:value":k[1]||(k[1]=V=>s.value.commitMessage=V),placeholder:"请输入本次提交的主要信息，合理的描信息有利于代历史记录的查理"},null,8,["value"])]),_:1})]),_:1},8,["model"]),x("div",yt,[C(S,{onClick:y},{default:w(()=>k[3]||(k[3]=[O("取消")])),_:1,__:[3]}),C(S,{type:"primary",onClick:r},{default:w(()=>k[4]||(k[4]=[O("确定")])),_:1,__:[4]})])]),_:1},8,["open"])}}}),Rt=W(_t,[["__scopeId","data-v-81b8c3fd"]]),ht={class:"repository-modal-content"},kt={class:"modal-icon"},wt={class:"modal-footer"},Ct=J({__name:"RepositoryModal",props:{open:{type:Boolean}},emits:["update:open","confirm","cancel"],setup(_,{emit:v}){const l=v,I=()=>{l("confirm")},d=()=>{l("cancel")};return(s,g)=>{const y=Z,r=H;return R(),B(r,{open:s.open,title:"开启代码库",footer:null,width:"480px",centered:"","onUpdate:open":g[0]||(g[0]=h=>s.$emit("update:open",h))},{default:w(()=>[x("div",ht,[x("div",kt,[C(z(Ue),{style:{color:"#faad14","font-size":"24px"}})]),g[1]||(g[1]=x("div",{class:"modal-text"}," 新建实践题关卡时，需要使用代码仓库；如果只有选择关卡，则不需要代码仓库。代码仓库启用后，将无法关闭。 ",-1))]),x("div",wt,[C(y,{onClick:d},{default:w(()=>g[2]||(g[2]=[O("不开启")])),_:1,__:[2]}),C(y,{type:"primary",onClick:I},{default:w(()=>g[3]||(g[3]=[O("开启")])),_:1,__:[3]})])]),_:1},8,["open"])}}}),Ut=W(Ct,[["__scopeId","data-v-a8bbff12"]]),bt={class:"ai-buttons-bar"},Ft={class:"options-list"},Tt=["onClick"],xt=J({__name:"QuestionModal",props:{open:{type:Boolean},question:{},projectId:{},taskId:{},existingQuestions:{}},emits:["update:open","confirm"],setup(_,{emit:v}){const l=_,I=v,d=L(),s=L({id:"",name:"",options:[{id:"1",label:"A",content:"",isCorrect:!1},{id:"2",label:"B",content:"",isCorrect:!1},{id:"3",label:"C",content:"",isCorrect:!1},{id:"4",label:"D",content:"",isCorrect:!1}],answerKey:""}),y={name:[{required:!0,message:"请输入题干"},{validator:(n,t)=>!t||!t.replace(/<[^>]*>/g,"").trim()?Promise.reject("请输入内容"):Promise.resolve()}],answerKey:[{required:!0,message:"请输入答案解析",trigger:"blur"}]},r=n=>{let t=[];try{t=JSON.parse(n.selects||"[]").map((f,$)=>{const T=Object.keys(f)[0];return{id:($+1).toString(),label:T,content:f[T],isCorrect:n.answer.includes(T)}})}catch{t=[{id:"1",label:"A",content:"",isCorrect:!1},{id:"2",label:"B",content:"",isCorrect:!1},{id:"3",label:"C",content:"",isCorrect:!1},{id:"4",label:"D",content:"",isCorrect:!1}]}return{id:n.id,name:n.name,options:t,answerKey:n.answerKey}};se(()=>l.open,n=>{n&&(l.question?s.value=r(l.question):s.value={id:Date.now().toString(),name:"",options:[{id:"1",label:"A",content:"",isCorrect:!1},{id:"2",label:"B",content:"",isCorrect:!1},{id:"3",label:"C",content:"",isCorrect:!1},{id:"4",label:"D",content:"",isCorrect:!1}],answerKey:""})});const h=()=>{var n;I("update:open",!1),(n=d.value)==null||n.resetFields()},k=n=>{var $,T;const t=n.options.filter(m=>m.content.trim()).map(m=>({[m.label]:m.content})),i=n.options.filter(m=>m.isCorrect).map(m=>m.label).join(",");let f=1;return l.question&&l.question.weight?f=l.question.weight:l.existingQuestions&&l.existingQuestions.length>0&&(f=Math.max(...l.existingQuestions.map(A=>A.weight||0))+1),{id:n.id,name:n.name,answer:i,answerKey:n.answerKey,selects:JSON.stringify(t),projectId:l.projectId||(($=l.question)==null?void 0:$.projectId),taskId:l.taskId||((T=l.question)==null?void 0:T.taskId),weight:f}},N=async()=>{var n,t,i,f;try{if(await((n=d.value)==null?void 0:n.validate()),!s.value.options.some(b=>b.content.trim())){p.error("请至少填写一个选项");return}if(!s.value.options.some(b=>b.isCorrect)){p.error("请至少设置一个正确答案");return}if(!l.projectId){p.error("项目ID不存在");return}if(!l.taskId){p.error("任务关卡ID不存在，请先保存任务关卡");return}const m=k(s.value),A=l.question&&l.question.id;console.log("=== 题目参数 ==="),console.log("操作模式:",A?"编辑":"新增"),console.log("题目ID (id):",m.id),console.log("题目数据:",m),console.log("项目ID (projectId):",m.projectId),console.log("任务ID (taskId):",m.taskId),console.log("排序权重 (weight):",m.weight),console.log("已有题目数量:",((t=l.existingQuestions)==null?void 0:t.length)||0),console.log("==================");try{if(A){console.log("编辑模式：调用更新接口");const b=await de({id:parseInt(m.id),name:m.name,answer:m.answer,answerKey:m.answerKey,selects:m.selects,projectId:m.projectId,taskId:m.taskId,weight:m.weight});console.log("题目更新成功，返回数据:",b),p.success("题目更新成功"),I("confirm",m),I("update:open",!1),(i=d.value)==null||i.resetFields()}else{const b=await Oe({name:m.name,answer:m.answer,answerKey:m.answerKey,selects:m.selects,projectId:m.projectId,taskId:m.taskId,weight:m.weight});console.log("题目创建成功，返回数据:",b),p.success("题目创建成功"),m.id=b.id.toString(),I("confirm",m),I("update:open",!1),(f=d.value)==null||f.resetFields()}}catch(b){console.error(A?"题目更新失败:":"题目创建失败:",b),p.error(b.message||(A?"题目更新失败，请重试":"题目创建失败，请重试"))}}catch{p.error("请完善必填信息")}},K=n=>{s.value.options.forEach(i=>{i.isCorrect=!1});const t=s.value.options.find(i=>i.id===n);t&&(t.isCorrect=!0)},Q=n=>{if(s.value.options.length<=2){p.warning("至少保留2个选项");return}const t=s.value.options.findIndex(i=>i.id===n);t!==-1&&(s.value.options.splice(t,1),s.value.options.forEach((i,f)=>{i.label=String.fromCharCode(65+f)}))},S=()=>{if(s.value.options.length>=10){p.warning("最多添加10个选项");return}const n=String.fromCharCode(65+s.value.options.length);s.value.options.push({id:Date.now().toString(),label:n,content:"",isCorrect:!1})},F=L(!1),V=L(!1),E=async()=>{if(!s.value.name){p.warning("请先输入题干内容");return}if(!s.value.name.replace(/<[^>]*>/g,"").trim()){p.warning("请先输入题干内容");return}try{V.value=!0,p.loading("AI正在润色题干，请稍候...",0);const t=await Qe(s.value.name);p.destroy(),s.value.name=t,p.success("AI润色成功")}catch(t){p.destroy(),console.error("AI润色失败:",t),p.error(t.message||"AI润色失败，请重试")}finally{V.value=!1}},j=async()=>{if(!s.value.name){p.warning("请先输入题干内容");return}if(!s.value.name.replace(/<[^>]*>/g,"").trim()){p.warning("请先输入题干内容");return}try{F.value=!0,p.loading("AI正在生成题目，请稍候...",0);const t=await je(s.value.name);if(p.destroy(),console.log("=== AI出题返回数据 ==="),console.log("返回结果:",t),t.title&&(s.value.name=t.title),t.options&&Array.isArray(t.options)&&t.options.length>0){const i=t.options.map((f,$)=>{const T=String.fromCharCode(65+$);return{id:($+1).toString(),label:T,content:f,isCorrect:!1}});s.value.options=i}if(t.answer){const i=t.answer.split(",").map(f=>f.trim());s.value.options.forEach(f=>{f.isCorrect=i.includes(f.label)})}t.analysis&&(s.value.answerKey=t.analysis),p.success("AI出题成功")}catch(t){p.destroy(),console.error("AI出题失败:",t),p.error(t.message||"AI出题失败，请重试")}finally{F.value=!1}};return(n,t)=>{const i=Z,f=oe,$=re,T=Ke,m=le,A=H;return R(),B(A,{open:n.open,title:n.question?"编辑题目":"添加题目",width:"900px","mask-closable":!1,onCancel:h},{footer:w(()=>[C(i,{onClick:h},{default:w(()=>t[5]||(t[5]=[O("取消")])),_:1,__:[5]}),C(i,{type:"primary",onClick:N},{default:w(()=>t[6]||(t[6]=[O("保存")])),_:1,__:[6]})]),default:w(()=>[C(m,{ref_key:"formRef",ref:d,model:s.value,rules:y,layout:"vertical"},{default:w(()=>[C(f,{label:"题干",name:"name",required:""},{default:w(()=>[x("div",bt,[C(i,{type:"primary",onClick:j,loading:F.value,size:"small"},{default:w(()=>t[2]||(t[2]=[O(" AI出题 ")])),_:1,__:[2]},8,["loading"]),C(i,{type:"primary",onClick:E,loading:V.value,size:"small"},{default:w(()=>t[3]||(t[3]=[O(" AI润色 ")])),_:1,__:[3]},8,["loading"])]),C(Ee,{modelValue:s.value.name,"onUpdate:modelValue":t[0]||(t[0]=b=>s.value.name=b),placeholder:"请您输入题干",height:150,"show-ai-embellish":!1},null,8,["modelValue"])]),_:1}),C(f,{required:""},{label:w(()=>t[4]||(t[4]=[x("span",null,[O("答案选项 "),x("span",{class:"options-hint ml-12px"},"点击字母设置正确答案（单选）")],-1)])),default:w(()=>[x("div",Ft,[(R(!0),P(te,null,ce(s.value.options,b=>(R(),P("div",{key:b.id,class:"option-item"},[x("div",{class:Ie(["option-label",{"is-correct":b.isCorrect}]),onClick:U=>K(b.id)},G(b.label),11,Tt),C($,{value:b.content,"onUpdate:value":U=>b.content=U,placeholder:"请输入选项内容",class:"option-input"},null,8,["value","onUpdate:value"]),s.value.options.length>2?(R(),B(z(Ne),{key:0,class:"remove-icon",onClick:U=>Q(b.id)},null,8,["onClick"])):ie("",!0),b.id===s.value.options[s.value.options.length-1].id&&s.value.options.length<10?(R(),B(z(De),{key:1,class:"add-icon",onClick:S})):ie("",!0)]))),128))])]),_:1}),C(f,{label:"答案解析",name:"answerKey",required:""},{default:w(()=>[C(T,{value:s.value.answerKey,"onUpdate:value":t[1]||(t[1]=b=>s.value.answerKey=b),placeholder:"请输入答案解析",rows:1},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","title"])}}}),Nt=W(xt,[["__scopeId","data-v-403b19b6"]]);function Dt(){const _=L([]),v=L([]),l=L(null),I=L({}),d=L({}),s=n=>I.value[n]?I.value[n]:`// 文件内容加载中...
// 请从Git仓库加载文件`,g=n=>{var f;const t=(f=n.split(".").pop())==null?void 0:f.toLowerCase();return{vue:"vue",js:"javascript",ts:"typescript",html:"html",css:"css",json:"json",md:"markdown"}[t||""]||"javascript"},y=(n,t)=>{var m;if(n.length===0||!t.node)return;const i=t.node;if(!i.isLeaf)return;const f=n[0],$=i.title,T=((m=i.dataRef)==null?void 0:m.fileUrl)||i.fileUrl;l.value={key:f,title:$,content:"",fileUrl:T||null},console.log("选中文件:",{key:f,title:$,fileUrl:T})},r=Y(()=>""),h=n=>{const t=(i,f,$="")=>{for(const T of i){const m=$+"/"+T.title;if(T.key===f)return m;if(T.children){const A=t(T.children,f,m);if(A)return A}}return null};return t(_.value,n)||"/"},k=(n,t,i)=>{const f=`0-new-file-${Date.now()}`,$={title:n,key:f,isLeaf:!0};I.value[f]=t;const T=i==="/"?n:`${i.replace(/^\//,"")}/${n}`;if(d.value[f]=T,i==="/")_.value.push($);else{const m=(A,b)=>{for(const U of A){const ee=d.value[U.key]||h(U.key);if(ee===b||ee===b.replace(/^\//,""))return U.children||(U.children=[]),U.children.push($),v.value.includes(U.key)||v.value.push(U.key),!0;if(U.children&&m(U.children,b))return!0}return!1};m(_.value,i)}},N=(n,t)=>{const i=`0-new-folder-${Date.now()}`,f={title:n,key:i,isLeaf:!1,children:[]},$=t==="/"?n:`${t.replace(/^\//,"")}/${n}`;if(d.value[i]=$,t==="/")_.value.push(f);else{const T=(m,A)=>{for(const b of m){const U=d.value[b.key]||h(b.key);if(U===A||U===A.replace(/^\//,""))return b.children||(b.children=[]),b.children.push(f),v.value.includes(b.key)||v.value.push(b.key),!0;if(b.children&&T(b.children,A))return!0}return!1};T(_.value,t)}v.value.push(i)},K=n=>{H.confirm({title:"重命名",content:ae("div",[ae("p",`当前名称：${n.title}`),ae("input",{id:"rename-input",placeholder:"请输入新名称",style:"width: 100%; padding: 4px 11px; border: 1px solid #d9d9d9; border-radius: 2px;"})]),onOk:()=>{const t=document.getElementById("rename-input"),i=t==null?void 0:t.value.trim();if(!i)return p.error("请输入新名称"),Promise.reject();const f=$=>{for(const T of $){if(T.key===n.key)return T.title=i,p.success("重命名成功"),!0;if(T.children&&f(T.children))return!0}return!1};f(_.value),l.value&&l.value.key===n.key&&(l.value.title=i)}})},Q=n=>{const t=h(n.key);navigator.clipboard.writeText(t).then(()=>{p.success(`路径已复制到剪贴板: ${t}`)}).catch(()=>{p.error("复制失败")})},S=n=>{const t=n.children!==void 0||n.isLeaf===!1;H.confirm({title:"确认删除",content:`确定要删除${t?"文件夹":"文件"} "${n.title}" 吗？${t?"文件夹下的所有内容也会被删除。":""}`,okText:"确定",cancelText:"取消",okType:"danger",onOk:()=>{const i=f=>{var T;const $=f.findIndex(m=>m.key===n.key);if($!==-1)return f.splice($,1),p.success("删除成功"),((T=l.value)==null?void 0:T.key)===n.key&&(l.value=null),I.value[n.key]&&delete I.value[n.key],!0;for(const m of f)if(m.children&&i(m.children))return!0;return!1};i(_.value)}})},F=(n,t="0",i="")=>!n||!Array.isArray(n)?(console.warn("convertApiDataToTreeNodes: apiData is not an array",n),[]):n.map((f,$)=>{const T=`${t}-${$}`,m=i?`${i}/${f.fileName}`:f.fileName,A={title:f.fileName||"untitled",key:T,fileUrl:f.fileUrl||null};return d.value[T]=m,f.fileType==="dir"?(A.isLeaf=!1,A.children=[]):A.isLeaf=!0,A});return{fileTreeData:_,expandedKeys:v,selectedFile:l,dynamicFileContents:I,highlightedCode:r,getFileContent:s,getLanguageByFilename:g,handleSelectFile:y,getNodePath:h,addFileToTree:k,addFolderToTree:N,handleRenameNode:K,handleCopyPath:Q,handleDeleteNode:S,loadRemoteFileTree:n=>{try{console.log("加载远程文件树，原始数据:",n),d.value={},I.value={};const t=F(n,"0","");console.log("转换后的树节点:",t),_.value=t,v.value=[],l.value=null}catch(t){console.error("加载文件树失败:",t),_.value=[]}},loadChildrenData:(n,t)=>{try{console.log("加载子文件夹数据:",{nodeKey:n,apiData:t});const i=d.value[n]||"",f=F(t,n,i);console.log("转换后的子节点:",f);const $=m=>{for(const A of m){if(A.key===n)return A.children=f,!0;if(A.children&&$(A.children))return!0}return!1};$(_.value)||console.warn("未找到对应的节点进行更新:",n)}catch(i){console.error("加载子文件夹失败:",i)}},getNodePathFromMap:n=>d.value[n]||""}}function Kt(_){const v=L([]),l=L(""),I=L("task"),d=L(),s=L(),g=L({name:"",source:"",require:"",referenceAnswer:"",difficulty:2,tag:"",classHour:"",jumpUrl:"",type:1,projectId:(_==null?void 0:_.value)||void 0}),y=L([]),r=L({timeLimitM:0,userFiles:[],testValidateFiles:[],testValidateSh:"",passType:1,passTypeRule:"",blankCode:1,scoreRule:1,testValidateType:1,testContent:[]}),h=L([]),k=L([]),N=(o,e)=>!e||!e.replace(/<[^>]*>/g,"").trim()?Promise.reject("请输入内容"):Promise.resolve(),K={name:[{required:!0,message:"请输入任务名称",trigger:"blur"}],source:[{required:!0,message:"请上传学习资源",trigger:"change"}],require:[{required:!0,message:""},{validator:N}],referenceAnswer:[{required:!0,message:""},{validator:N}],difficulty:[{required:!0,message:"请选择难度系数",trigger:"change"}],tag:[{required:!0,message:"请输入技能标签",trigger:"blur"}],classHour:[{required:!0,message:"请输入任务学时",trigger:"blur"}],jumpUrl:[{required:!0,message:"请输入内嵌链接",trigger:"blur"}]},Q={timeLimitM:[{required:!0,message:"请输入评测时长限制",trigger:"blur"}],userFiles:[{required:!0,message:"请上传学员任务文件",trigger:"change",type:"array",min:1}],testValidateFiles:[{required:!0,message:"请上传评测执行文件",trigger:"change",type:"array",min:1}],testValidateSh:[{required:!0,message:"请输入评测执行命令",trigger:"blur"}]},S=Y(()=>{if(!l.value)return!1;const o=v.value.find(e=>e.id===l.value);return(o==null?void 0:o.type)==="kernel"}),F=Y(()=>{if(!l.value)return!1;const o=v.value.find(e=>e.id===l.value);return(o==null?void 0:o.type)==="choice"}),V=Y(()=>{if(!l.value)return!1;const o=v.value.find(e=>e.id===l.value);return(o==null?void 0:o.type)==="programming"}),E=o=>{if(v.value.some(c=>!c.taskId)){p.warning("请先保存当前未保存的任务关卡，再添加新关卡");return}if(l.value){const c=v.value.find(q=>q.id===l.value);if(c&&c.taskId){if(c.type==="choice"&&(!c.questions||c.questions.length===0)){p.warning("请至少新增一条题目"),I.value="questions";return}if(c.type==="programming"&&(!c.evaluationSettings||!c.evaluationSettings.testContent||c.evaluationSettings.testContent.length===0)){p.warning("请先配置评测设置后再添加新关卡"),I.value="evaluation";return}}}const a={programming:"编程实训任务关卡",choice:"选择题实训任务关卡",kernel:"内核链接实训任务关卡"},u={id:Date.now().toString(),name:`第${v.value.length+1}关：${a[o]}`,type:o,source:"",require:"",referenceAnswer:"",difficulty:2,tag:"",classHour:""};v.value.push(u),l.value=u.id,I.value="task",t(u.id),p.success("任务关卡添加成功")},j=o=>{var a;const e=v.value.findIndex(u=>u.id===o);e!==-1&&(v.value.splice(e,1),v.value.forEach((u,c)=>{const q=u.name.match(/^第\d+关：(.+)$/);if(q)u.name=`第${c+1}关：${q[1]}`;else{const D=u.name.indexOf("：");if(D!==-1){const X=u.name.substring(D+1);u.name=`第${c+1}关：${X}`}else u.name=`第${c+1}关：${u.name}`}}),l.value===o&&(l.value=((a=v.value[0])==null?void 0:a.id)||""),l.value&&t(l.value),p.success("任务关卡删除成功"))},n=async o=>{l.value&&l.value!==o&&i(l.value),l.value=o,I.value="task",t(o);const e=v.value.find(a=>a.id===o);e&&e.type==="choice"&&e.taskId&&await ne(e.taskId)},t=o=>{const e=v.value.find(a=>a.id===o);if(e){if(e.source){const u=e.source.split(",").filter(c=>c.trim());y.value=u.map((c,q)=>{const D=c.trim();return{uid:`${Date.now()}-${q}`,name:D.substring(D.lastIndexOf("/")+1),status:"done",url:D}})}else y.value=[];const a={programming:1,choice:2,kernel:4};g.value={name:e.name,source:e.source||"",require:e.require,referenceAnswer:e.referenceAnswer,difficulty:e.difficulty,tag:e.tag,classHour:e.classHour,jumpUrl:e.jumpUrl||"",type:a[e.type]||3,projectId:(_==null?void 0:_.value)||void 0,taskId:e.taskId},e.evaluationSettings?(r.value={...e.evaluationSettings},e.evaluationSettings.userFiles&&Array.isArray(e.evaluationSettings.userFiles)?h.value=e.evaluationSettings.userFiles:h.value=[],e.evaluationSettings.testValidateFiles&&Array.isArray(e.evaluationSettings.testValidateFiles)?k.value=e.evaluationSettings.testValidateFiles:k.value=[]):(r.value={timeLimitM:0,userFiles:[],testValidateFiles:[],testValidateSh:"",passType:1,passTypeRule:"",blankCode:1,scoreRule:1,testValidateType:1,testContent:[]},h.value=[],k.value=[])}},i=o=>{const e=v.value.find(a=>a.id===o);if(e){const a=e.questions;e.source=g.value.source,e.require=g.value.require,e.referenceAnswer=g.value.referenceAnswer,e.difficulty=g.value.difficulty,e.tag=g.value.tag,e.classHour=g.value.classHour,e.jumpUrl=g.value.jumpUrl,g.value.taskId&&(e.taskId=g.value.taskId),e.questions=a,e.evaluationSettings={...r.value}}},f=async o=>{const{file:e,onSuccess:a,onError:u}=o;try{const c=await Pe(e);a({url:c},e)}catch(c){u(c)}},$=o=>{var c;const{file:e,fileList:a}=o;e.status==="done"?p.success(`${e.name} 文件上传成功`):e.status==="error"&&p.error(`${e.name} 文件上传失败`),y.value=a.map(q=>{var D;return{uid:q.uid,name:q.name,status:q.status,url:((D=q.response)==null?void 0:D.url)||q.url||""}});const u=y.value.filter(q=>q.url).map(q=>q.url).join(",");g.value.source=u,(c=d.value)==null||c.validateFields(["source"])},T=async()=>{var o,e,a;try{if(S.value||F.value)await((o=d.value)==null?void 0:o.validate());else if(V.value){if(await Promise.all([(e=d.value)==null?void 0:e.validate(),(a=s.value)==null?void 0:a.validate()]),g.value.taskId&&r.value.testValidateType===1&&r.value.testContent.length===0)throw p.error("用例类型为文本时，必须至少创建一条测试集"),new Error("用例类型为文本时，必须至少创建一条测试集");if(g.value.taskId&&r.value.testValidateType===1&&r.value.testContent.length>0&&r.value.testContent.find(D=>!D.arg.trim()||!D.answer.trim()))throw p.error("测试集的输入内容和期望输出不能为空"),new Error("测试集的输入内容和期望输出不能为空")}let u={...g.value};if(V.value){const q=r.value.testContent.map(M=>({arg:M.arg,answer:M.answer,select:M.select})),D=r.value.userFiles.filter(M=>M.url).map(M=>M.url).join(","),X=r.value.testValidateFiles.filter(M=>M.url).map(M=>M.url).join(",");u={...u,timeLimitM:r.value.timeLimitM,userFiles:D,testValidateFiles:X,passType:r.value.passType,passTypeRule:r.value.passTypeRule,blankCode:r.value.blankCode,scoreRule:r.value.scoreRule,testValidateSh:r.value.testValidateSh,testValidateType:r.value.testValidateType,testContent:JSON.stringify(q)}}console.log("准备提交的数据:",u);let c;g.value.taskId?(c=await ue({...u,taskId:g.value.taskId}),console.log("任务关卡更新成功，返回数据:",c),p.success("更新成功")):(c=await ze(u),console.log("任务关卡创建成功，返回数据:",c),c.taskId&&(g.value.taskId=c.taskId,console.log("已保存 taskId:",c.taskId)),p.success("保存成功")),l.value&&i(l.value)}catch(u){throw console.error("保存任务关卡失败:",u),p.error("请完善必填信息"),u}},m=async()=>{l.value&&(i(l.value),console.log("已同步当前选中关卡的表单数据到本地状态"));const o=v.value.filter(a=>a.taskId);if(o.length===0){console.log("没有需要更新的任务关卡");return}console.log(`开始批量更新 ${o.length} 个任务关卡`);const e=[];for(const a of o)try{let u={taskId:a.taskId,name:a.name,source:a.source,require:a.require,referenceAnswer:a.referenceAnswer,difficulty:a.difficulty,tag:a.tag,classHour:a.classHour,jumpUrl:a.jumpUrl,projectId:(_==null?void 0:_.value)||void 0};if(a.type==="kernel")u.type=4;else if(a.type==="choice")u.type=2;else if(a.type==="programming"&&(u.type=1,a.evaluationSettings)){const c=a.evaluationSettings,q=c.testContent.map(M=>({arg:M.arg,answer:M.answer,select:M.select})),D=c.userFiles.filter(M=>M.url).map(M=>M.url).join(","),X=c.testValidateFiles.filter(M=>M.url).map(M=>M.url).join(",");u={...u,timeLimitM:c.timeLimitM,userFiles:D,testValidateFiles:X,passType:c.passType,passTypeRule:c.passTypeRule,blankCode:c.blankCode,scoreRule:c.scoreRule,testValidateSh:c.testValidateSh,testValidateType:c.testValidateType,testContent:JSON.stringify(q)}}await ue(u),console.log(`任务关卡 "${a.name}" 更新成功`)}catch(u){const c=`任务关卡 "${a.name}" 更新失败: ${u.message||"未知错误"}`;console.error(c,u),e.push(c)}if(e.length===0)p.success(`成功更新 ${o.length} 个任务关卡`);else throw e.length<o.length?(p.warning(`部分任务关卡更新失败：${e.join("; ")}`),new Error("部分任务关卡更新失败")):(p.error("所有任务关卡更新失败"),new Error("所有任务关卡更新失败"))},A=()=>{H.confirm({title:"确认重置",content:"确定要重置表单吗？所有未保存的数据将会丢失。",okText:"确定",cancelText:"取消",onOk:()=>{var e,a;let o=1;if(l.value){const u=v.value.find(c=>c.id===l.value);u&&(o={programming:1,choice:2,kernel:4}[u.type]||1)}g.value={name:"",source:"",require:"",referenceAnswer:"",difficulty:2,tag:"",classHour:"",jumpUrl:"",type:o,projectId:(_==null?void 0:_.value)||void 0},r.value={timeLimitM:0,userFiles:[],testValidateFiles:[],testValidateSh:"",passType:1,passTypeRule:"",blankCode:1,scoreRule:1,testValidateType:1,testContent:[]},y.value=[],h.value=[],k.value=[],(e=d.value)==null||e.clearValidate(),(a=s.value)==null||a.clearValidate(),p.success("已重置")}})},b=o=>{var u;const{file:e,fileList:a}=o;e.status==="done"?p.success(`${e.name} 文件上传成功`):e.status==="error"&&p.error(`${e.name} 文件上传失败`),h.value=a.map(c=>{var q;return{uid:c.uid,name:c.name,status:c.status,url:((q=c.response)==null?void 0:q.url)||c.url||""}}),r.value.userFiles=[...h.value],(u=s.value)==null||u.validateFields(["userFiles"])},U=o=>{var u;const{file:e,fileList:a}=o;e.status==="done"?p.success(`${e.name} 文件上传成功`):e.status==="error"&&p.error(`${e.name} 文件上传失败`),k.value=a.map(c=>{var q;return{uid:c.uid,name:c.name,status:c.status,url:((q=c.response)==null?void 0:q.url)||c.url||""}}),r.value.testValidateFiles=[...k.value],(u=s.value)==null||u.validateFields(["testValidateFiles"])},ee=o=>{var a;const e=o.map((u,c)=>({uid:`${Date.now()}-${c}`,name:u.name,status:"done",url:u.path}));h.value=e,r.value.userFiles=[...h.value],(a=s.value)==null||a.validateFields(["userFiles"]),p.success(`已选择 ${o.length} 个文件`)},pe=o=>{var a;const e=o.map((u,c)=>({uid:`${Date.now()}-${c}`,name:u.name,status:"done",url:u.path}));k.value=e,r.value.testValidateFiles=[...k.value],(a=s.value)==null||a.validateFields(["testValidateFiles"]),p.success(`已选择 ${o.length} 个文件`)},me=()=>{r.value.testContent.push({id:Date.now().toString(),arg:"",answer:"",select:1})},fe=o=>{const e=r.value.testContent.findIndex(a=>a.id===o);e!==-1&&(r.value.testContent.splice(e,1),p.success("删除成功"))},ve=()=>{r.value.testContent=[],p.success("已清空所有测试用例")},ge=()=>{p.info("下载功能开发中...")},ye=()=>{p.info("批量上传功能开发中...")},_e=Y(()=>{if(!l.value)return[];const o=v.value.find(e=>e.id===l.value);return(o==null?void 0:o.questions)||[]}),he=o=>{if(!l.value)return;const e=v.value.find(a=>a.id===l.value);e&&(e.questions||(e.questions=[]),e.questions.push(o),p.success("题目添加成功"))},ke=async o=>{l.value&&H.confirm({title:"确认删除",content:"确定要删除这道题目吗？删除后无法恢复。",okText:"确定",cancelText:"取消",async onOk(){try{console.log("开始删除题目，ID:",o),await He({id:parseInt(o)}),console.log("题目删除成功"),p.success("题目删除成功");const e=v.value.find(a=>a.id===l.value);if(e&&e.questions){const a=e.questions.findIndex(u=>u.id===o);a!==-1&&e.questions.splice(a,1)}e&&e.taskId&&await ne(e.taskId)}catch(e){console.error("题目删除失败:",e),p.error(e.message||"题目删除失败，请重试")}}})},we=o=>{if(!l.value)return;const e=v.value.find(a=>a.id===l.value);if(e&&e.questions){const a=e.questions.findIndex(u=>u.id===o.id);a!==-1&&(e.questions[a]=o,p.success("题目更新成功"))}},Ce=o=>{if(!l.value)return;const e=v.value.find(a=>a.id===l.value);e&&(e.questions=o)},be=async o=>{if(!(_!=null&&_.value))throw new Error("项目ID不存在");try{console.log("批量更新题目排序，共",o.length,"个题目");const e=o.map(a=>de({id:parseInt(a.id),name:a.name,answer:a.answer,answerKey:a.answerKey,selects:a.selects,projectId:a.projectId||_.value,taskId:a.taskId,weight:a.weight}));await Promise.all(e),console.log("题目排序保存成功")}catch(e){throw console.error("保存题目排序失败:",e),e}},ne=async o=>{if(!(_!=null&&_.value)){console.error("项目ID不存在");return}try{console.log("开始加载题目列表，参数:",{projectId:_.value,taskId:o});const e=await Be({projectId:_.value,taskId:o});console.log("题目列表加载成功:",e);const a=e.map(u=>({id:u.id.toString(),name:u.name,answer:u.answer,answerKey:u.answerKey,selects:u.selects,projectId:u.projectId,taskId:u.taskId,weight:u.weight})).sort((u,c)=>(u.weight||0)-(c.weight||0));if(l.value){const u=v.value.find(c=>c.id===l.value);u&&(u.questions=a,console.log("题目列表已更新到任务关卡:",u.name,"题目数量:",a.length))}}catch(e){console.error("加载题目列表失败:",e),p.error(e.message||"加载题目列表失败")}};return{taskLevels:v,selectedTaskLevelId:l,currentTab:I,taskLevelFormRef:d,evaluationFormRef:s,taskLevelFormData:g,evaluationFormData:r,learningResourceFileList:y,taskLevelFormRules:K,evaluationFormRules:Q,isKernelTask:S,isChoiceTask:F,isProgrammingTask:V,addTaskLevel:E,deleteTaskLevel:j,selectTaskLevel:n,saveTaskLevel:T,saveAllTaskLevels:m,resetTaskLevel:A,handleLearningResourceCustomRequest:f,handleLearningResourceUpload:$,handleUserFilesUpload:b,handleTestValidateFilesUpload:U,handleUserFilesSelect:ee,handleTestValidateFilesSelect:pe,userFileList:h,testValidateFileList:k,addTestCase:me,removeTestCase:fe,clearAllTestCases:ve,downloadTemplate:ge,batchUploadTestCases:ye,getCurrentQuestions:_e,addQuestion:he,deleteQuestion:ke,updateQuestion:we,updateQuestionsOrder:Ce,loadQuestions:ne,saveQuestionsOrder:be}}export{Lt as F,Mt as N,Nt as Q,Ut as R,Kt as a,Vt as b,Rt as c,Dt as u};
