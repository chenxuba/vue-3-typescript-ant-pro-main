import{g as De,u as te,d as le,c as Pe}from"./role-eO0d-0Mc.js";import{q as U,_ as Ne}from"./index-DmgcJQeo.js";import{z as Ue,I as Ke,S as qe,H as ze,K as Be,ab as Fe,af as Oe,an as Ve,a6 as Le,ai as je,ah as He,M as G,y as Qe,ak as Ge,aw as Je,X as Xe,a1 as v,al as ne}from"./antd-Cme2pY03.js";import{d as Ye,r as se,f as d,o as We,_ as $,a1 as k,$ as p,k as t,a7 as l,G as u,a9 as w,u as oe,a6 as K,ac as ie,l as ue}from"./vue-PnzzEkKE.js";const Ze={class:"role-management"},ea={class:"content-wrapper"},aa={class:"main-panel"},ta={class:"query-form"},la={class:"table-header"},na={class:"table-info"},sa={class:"info-value"},oa={class:"table-actions"},ia={class:"table-container"},ua={key:0,class:"role-link"},ra={key:1},da={key:2},ma={key:3},pa={style:{padding:"20px 0"}},ca={style:{"max-height":"400px",overflow:"auto",padding:"10px",background:"#fafafa","border-radius":"4px"}},va={style:{padding:"20px 0"}},fa={style:{"margin-bottom":"16px"}},ya={style:{display:"flex","justify-content":"space-between",color:"#666","font-size":"14px"}},_a={style:{color:"#52c41a"}},ga={style:{color:"#f5222d"}},ha={key:0,style:{"margin-top":"16px","text-align":"center",color:"#666"}},ka={key:1,style:{color:"#999","font-size":"12px"}},ba=Ye({name:"RoleManagement",__name:"role-management",setup(Ca){const re=a=>{if(!a)return"-";const e=new Date(typeof a=="number"?a:parseInt(a));if(isNaN(e.getTime()))return"-";const r=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),c=String(e.getHours()).padStart(2,"0"),_=String(e.getMinutes()).padStart(2,"0"),g=String(e.getSeconds()).padStart(2,"0");return`${r}-${s}-${o} ${c}:${_}:${g}`},f=se({name:"",page:1,limit:20,orderbyFiled:"name:desc"}),q=d(!1),J=d([]),z=d(0),x=d([]),A=d([]),de=[{title:"角色名称",dataIndex:"name",key:"name"},{title:"角色编码",dataIndex:"code",key:"code"},{title:"管理范围",dataIndex:"authTypeContent",key:"authTypeContent"},{title:"创建时间",dataIndex:"createTime",key:"createTime"},{title:"备注",dataIndex:"remark",key:"remark",ellipsis:!0},{title:"操作",key:"action",width:220,fixed:"right"}],E=d(!1),B=d(!1),F=d("新建角色"),D=d(!1),P=d(void 0),I=d(!1),O=d(!1),y=d(null),b=d([]),V=d([]),R=d(!1),L=d(0),j=d(0),N=d(0),S=d(0),M=d(0),C=d("active"),n=se({name:"",code:"",isAdmin:void 0,authType:void 0,authTypeContent:void 0,remark:""}),T=async()=>{q.value=!0;try{const a={page:f.page,limit:f.limit,orderbyFiled:f.orderbyFiled};f.name&&f.name.trim()&&(a.name=f.name);const e=await De(a);e.data&&(J.value=e.data.list,z.value=e.data.count)}catch{v.error("获取角色列表失败")}finally{q.value=!1}},X=()=>{f.page=1,x.value=[],A.value=[],T()},me=()=>{f.name="",f.page=1,f.limit=20,f.orderbyFiled="name:desc",x.value=[],A.value=[],T()},pe=(a,e)=>{x.value=a,A.value=e},ce=a=>({disabled:a.code==="admin"}),ve=()=>{F.value="新建角色",D.value=!1,P.value=void 0,n.name="",n.code="",n.isAdmin=void 0,n.authType=void 0,n.authTypeContent=void 0,n.remark="",E.value=!0},fe=a=>{if(a.code==="admin"){v.warning("admin 角色不允许编辑");return}F.value="编辑角色",D.value=!0,P.value=a.roleId||a.id,n.name=a.name||a.roleName||"",n.code=a.code||"",n.isAdmin=a.isAdmin,n.authType=a.authType,n.authTypeContent=a.authTypeContent,n.remark=a.remark||"",E.value=!0},ye=async()=>{B.value=!0;try{if(D.value&&P.value){if(!n.name||!n.code||n.isAdmin===void 0||n.authType===void 0||!n.authTypeContent){v.error("请填写所有必填项");return}await te({roleId:P.value,name:n.name,code:n.code,isAdmin:n.isAdmin,authType:n.authType,authTypeContent:n.authTypeContent,remark:n.remark}),v.success("更新成功")}else{if(!n.name||!n.code||n.isAdmin===void 0||n.authType===void 0||!n.authTypeContent){v.error("请填写所有必填项");return}await Pe({name:n.name,code:n.code,isAdmin:n.isAdmin,authType:n.authType,authTypeContent:n.authTypeContent,remark:n.remark}),v.success("创建成功")}E.value=!1,T()}catch{v.error(D.value?"更新失败":"创建失败")}finally{B.value=!1}},_e=()=>{const a={};return U.forEach(e=>{var r;(r=e.meta)!=null&&r.access&&Array.isArray(e.meta.access)&&(a[e.path]=e.meta.access),e.children&&e.children.length>0&&e.children.forEach(s=>{var o;(o=s.meta)!=null&&o.access&&Array.isArray(s.meta.access)&&(a[s.path]=s.meta.access)})}),a},ge=()=>{const a={};return U.forEach(e=>{var r;(r=e.meta)!=null&&r.access&&Array.isArray(e.meta.access)&&e.meta.access.forEach(s=>{a[s]||(a[s]=[]),a[s].includes(e.path)||a[s].push(e.path)}),e.children&&e.children.length>0&&e.children.forEach(s=>{var o;(o=s.meta)!=null&&o.access&&Array.isArray(s.meta.access)&&s.meta.access.forEach(c=>{a[c]||(a[c]=[]),a[c].includes(s.path)||a[c].push(s.path)})})}),a},he=()=>{const a=[];return U.forEach(e=>{var s,o;if((s=e.meta)!=null&&s.hideInMenu)return;const r={key:e.path,title:((o=e.meta)==null?void 0:o.title)||e.name,children:[]};e.children&&e.children.length>0&&e.children.filter(_=>{var g,m;return(g=e.meta)!=null&&g.hideChildrenInMenu?!1:!((m=_.meta)!=null&&m.hideInMenu)}).forEach(_=>{var g;r.children.push({key:_.path,title:((g=_.meta)==null?void 0:g.title)||_.name})}),a.push(r)}),a},ke=_e(),be=ge(),Y=d(he()),Ce=async a=>{if(a.code==="admin"){v.warning("admin 角色不允许修改权限");return}if(y.value=a,I.value=!0,V.value=Y.value.map(e=>e.key),a.authMenus){const e=a.authMenus.split(",").filter(s=>s.trim()),r=new Set;e.forEach(s=>{const o=be[s.trim()];o&&Array.isArray(o)&&o.forEach(c=>r.add(c))}),b.value=Array.from(r),console.log("角色权限标识:",e),console.log("转换后的路由路径:",b.value)}else b.value=[]},we=async()=>{var a;if(((a=y.value)==null?void 0:a.code)==="admin"){v.warning("admin 角色不允许修改权限");return}O.value=!0;try{const e=new Set;b.value.forEach(o=>{const c=ke[o];c&&Array.isArray(c)&&c.forEach(_=>e.add(_))}),U.forEach(o=>{var c;o.children&&o.children.length>0&&o.children.some(g=>b.value.includes(g.path))&&(c=o.meta)!=null&&c.access&&Array.isArray(o.meta.access)&&o.meta.access.forEach(g=>e.add(g))});const r=Array.from(e).join(",");console.log("当前角色对象:",y.value),console.log("选中的路由路径:",b.value),console.log("对应的权限标识:",r);const s={roleId:y.value.roleId||y.value.id,name:y.value.name||y.value.roleName,isAdmin:y.value.isAdmin,authType:y.value.authType,authTypeContent:y.value.authTypeContent,remark:y.value.remark,authMenus:r};console.log("提交的参数:",s),await te(s),v.success("权限保存成功"),I.value=!1,T()}catch(e){console.error("权限保存失败:",e),v.error("权限保存失败")}finally{O.value=!1}},Te=()=>{I.value=!1,b.value=[],y.value=null},xe=a=>{if(a.code==="admin"){v.warning("admin 角色不允许删除");return}G.confirm({title:"确认删除",icon:ue(ne),content:`确定要删除角色"${a.name||a.roleName}"吗？`,okText:"确定",cancelText:"取消",onOk:async()=>{try{await le(a.roleId||a.id),v.success("删除成功"),T()}catch{v.error("删除失败")}}})},Ae=()=>{if(x.value.length===0){v.warning("请选择要删除的角色");return}const a=A.value.filter(e=>e.code!=="admin");if(a.length===0){v.warning("所选角色中包含 admin 角色，不允许删除");return}a.length<A.value.length&&v.warning("admin 角色不允许删除，将跳过该角色"),G.confirm({title:"确认批量删除",icon:ue(ne),content:`确定要删除选中的 ${a.length} 个角色吗？`,okText:"确定",cancelText:"取消",onOk:async()=>{await Se(a)}})},Se=async(a=A.value)=>{const e=a.length;j.value=e,N.value=0,L.value=0,S.value=0,M.value=0,C.value="active",R.value=!0;for(let r=0;r<a.length;r++){const s=a[r];N.value=r+1;try{await le(s.roleId||s.id),S.value++}catch(o){M.value++,console.error(`删除角色 ${s.name||s.roleName} 失败:`,o)}L.value=Math.floor(N.value/j.value*100)}C.value=M.value>0?"exception":"success",setTimeout(()=>{R.value=!1,S.value>0?(v.success(`成功删除 ${S.value} 个角色${M.value>0?`，失败 ${M.value} 个`:""}`),x.value=[],A.value=[],T()):v.error("批量删除失败")},1500)},Me=()=>{C.value!=="active"&&(R.value=!1)},$e=a=>{f.page=a.current,f.limit=a.pageSize,T()};return We(()=>{T()}),(a,e)=>{var ee;const r=Ke,s=Ue,o=ze,c=qe,_=Be,g=Ve,m=je,H=Le,Ee=He,Q=G,W=Qe,Ie=Ge,Re=Je,Z=Xe;return k(),$("div",Ze,[p("div",ea,[p("div",aa,[e[22]||(e[22]=p("div",{class:"query-header"},[p("h3",null,"筛选查询")],-1)),p("div",ta,[t(_,{layout:"inline"},{default:l(()=>[t(s,{label:"角色名称"},{default:l(()=>[t(r,{value:f.name,"onUpdate:value":e[0]||(e[0]=i=>f.name=i),placeholder:"请输入","allow-clear":"",style:{width:"200px"},onPressEnter:X},null,8,["value"])]),_:1}),t(s,null,{default:l(()=>[t(c,null,{default:l(()=>[t(o,{type:"primary",onClick:X},{default:l(()=>e[12]||(e[12]=[u(" 查询 ")])),_:1,__:[12]}),t(o,{onClick:me},{default:l(()=>e[13]||(e[13]=[u(" 重置 ")])),_:1,__:[13]})]),_:1})]),_:1})]),_:1})]),p("div",la,[p("div",na,[e[14]||(e[14]=p("span",{class:"info-label"},"数据列表",-1)),e[15]||(e[15]=p("span",{class:"info-divider"},"数据共",-1)),p("span",sa,w(z.value),1),e[16]||(e[16]=p("span",{class:"info-unit"},"条",-1))]),p("div",oa,[t(o,{type:"primary",onClick:ve},{icon:l(()=>[t(oe(Fe))]),default:l(()=>[e[17]||(e[17]=u(" 新建角色 "))]),_:1,__:[17]}),t(o,{danger:"",disabled:x.value.length===0,onClick:Ae},{icon:l(()=>[t(oe(Oe))]),default:l(()=>[e[18]||(e[18]=u(" 批量删除 "))]),_:1,__:[18]},8,["disabled"])])]),p("div",ia,[t(g,{columns:de,"data-source":J.value,loading:q.value,pagination:{current:f.page,pageSize:f.limit,total:z.value,showSizeChanger:!0,showQuickJumper:!0,showTotal:i=>`共 ${i} 条`},"row-selection":{selectedRowKeys:x.value,onChange:pe,getCheckboxProps:ce},scroll:{x:1e3},"row-key":i=>i.roleId||i.id,onChange:$e},{bodyCell:l(({column:i,record:h})=>[i.key==="name"?(k(),$("a",ua,w(h.name||h.roleName),1)):i.key==="code"?(k(),$("span",ra,w(h.code||"-"),1)):i.key==="createTime"?(k(),$("span",da,w(re(h.createTime)),1)):i.key==="remark"?(k(),$("span",ma,w(h.remark||"-"),1)):i.key==="action"?(k(),K(c,{key:4},{default:l(()=>[t(o,{type:"link",size:"small",disabled:h.code==="admin",onClick:ae=>fe(h)},{default:l(()=>e[19]||(e[19]=[u(" 编辑 ")])),_:2,__:[19]},1032,["disabled","onClick"]),t(o,{type:"link",size:"small",disabled:h.code==="admin",onClick:ae=>Ce(h)},{default:l(()=>e[20]||(e[20]=[u(" 权限管理 ")])),_:2,__:[20]},1032,["disabled","onClick"]),t(o,{type:"link",size:"small",danger:"",disabled:h.code==="admin",onClick:ae=>xe(h)},{default:l(()=>e[21]||(e[21]=[u(" 删除 ")])),_:2,__:[21]},1032,["disabled","onClick"])]),_:2},1024)):ie("",!0)]),_:1},8,["data-source","loading","pagination","row-selection","row-key"])])])]),t(Q,{open:E.value,"onUpdate:open":e[7]||(e[7]=i=>E.value=i),title:F.value,width:600,"confirm-loading":B.value,onOk:ye},{default:l(()=>[t(_,{model:n,"label-col":{span:8},"wrapper-col":{span:14},style:{"margin-top":"24px"}},{default:l(()=>[t(s,{label:"角色名称",name:"name",rules:[{required:!0,message:"请输入角色名称",trigger:"blur"}]},{default:l(()=>[t(r,{value:n.name,"onUpdate:value":e[1]||(e[1]=i=>n.name=i),placeholder:"请输入角色名称","allow-clear":""},null,8,["value"])]),_:1}),t(s,{label:"角色编码",name:"code",rules:[{required:!0,message:"请输入角色编码",trigger:"blur"}]},{default:l(()=>[t(r,{value:n.code,"onUpdate:value":e[2]||(e[2]=i=>n.code=i),placeholder:"请输入角色编码","allow-clear":""},null,8,["value"])]),_:1}),t(s,{label:"是否虚拟机构管理员角色",name:"isAdmin",rules:[{required:!0,message:"请选择",trigger:"change"}]},{default:l(()=>[t(H,{value:n.isAdmin,"onUpdate:value":e[3]||(e[3]=i=>n.isAdmin=i),placeholder:"请选择","allow-clear":""},{default:l(()=>[t(m,{value:1},{default:l(()=>e[23]||(e[23]=[u("是")])),_:1,__:[23]}),t(m,{value:0},{default:l(()=>e[24]||(e[24]=[u("否")])),_:1,__:[24]})]),_:1},8,["value"])]),_:1}),t(s,{label:"管理范围类型",name:"authType",rules:[{required:!0,message:"请选择管理范围类型",trigger:"change"}]},{default:l(()=>[t(H,{value:n.authType,"onUpdate:value":e[4]||(e[4]=i=>n.authType=i),placeholder:"请选择","allow-clear":""},{default:l(()=>[t(m,{value:0},{default:l(()=>e[25]||(e[25]=[u("全部数据")])),_:1,__:[25]}),t(m,{value:1},{default:l(()=>e[26]||(e[26]=[u("本单位及下属单位")])),_:1,__:[26]}),t(m,{value:2},{default:l(()=>e[27]||(e[27]=[u("仅本单位")])),_:1,__:[27]}),t(m,{value:3},{default:l(()=>e[28]||(e[28]=[u("本部门及下属部门")])),_:1,__:[28]}),t(m,{value:4},{default:l(()=>e[29]||(e[29]=[u("仅本部门")])),_:1,__:[29]}),t(m,{value:5},{default:l(()=>e[30]||(e[30]=[u("指定范围")])),_:1,__:[30]})]),_:1},8,["value"])]),_:1}),t(s,{label:"管理范围",name:"authTypeContent",rules:[{required:!0,message:"请选择管理范围",trigger:"change"}]},{default:l(()=>[t(H,{value:n.authTypeContent,"onUpdate:value":e[5]||(e[5]=i=>n.authTypeContent=i),placeholder:"请选择","allow-clear":""},{default:l(()=>[t(m,{value:"全部"},{default:l(()=>e[31]||(e[31]=[u("全部")])),_:1,__:[31]}),t(m,{value:"计算机网络信息中心"},{default:l(()=>e[32]||(e[32]=[u("计算机网络信息中心")])),_:1,__:[32]}),t(m,{value:"大数据技术与应用发展部"},{default:l(()=>e[33]||(e[33]=[u("大数据技术与应用发展部")])),_:1,__:[33]}),t(m,{value:"高性能计算技术与应用发展部"},{default:l(()=>e[34]||(e[34]=[u("高性能计算技术与应用发展部")])),_:1,__:[34]}),t(m,{value:"网络安全部"},{default:l(()=>e[35]||(e[35]=[u("网络安全部")])),_:1,__:[35]}),t(m,{value:"系统运维部"},{default:l(()=>e[36]||(e[36]=[u("系统运维部")])),_:1,__:[36]}),t(m,{value:"技术研发部"},{default:l(()=>e[37]||(e[37]=[u("技术研发部")])),_:1,__:[37]}),t(m,{value:"综合管理部"},{default:l(()=>e[38]||(e[38]=[u("综合管理部")])),_:1,__:[38]}),t(m,{value:"人力资源部"},{default:l(()=>e[39]||(e[39]=[u("人力资源部")])),_:1,__:[39]}),t(m,{value:"财务部"},{default:l(()=>e[40]||(e[40]=[u("财务部")])),_:1,__:[40]})]),_:1},8,["value"])]),_:1}),t(s,{label:"备注"},{default:l(()=>[t(Ee,{value:n.remark,"onUpdate:value":e[6]||(e[6]=i=>n.remark=i),placeholder:"请输入备注",rows:3,"allow-clear":""},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","title","confirm-loading"]),t(Q,{open:I.value,"onUpdate:open":e[10]||(e[10]=i=>I.value=i),title:`${((ee=y.value)==null?void 0:ee.roleName)||""}角色权限编辑`,width:600,maskClosable:!1},{footer:l(()=>[t(o,{onClick:Te},{default:l(()=>e[41]||(e[41]=[u("取消")])),_:1,__:[41]}),t(o,{type:"primary",loading:O.value,onClick:we},{default:l(()=>e[42]||(e[42]=[u(" 保存 ")])),_:1,__:[42]},8,["loading"])]),default:l(()=>[p("div",pa,[t(W,{message:"请选择该角色可以访问的功能模块",type:"info","show-icon":"",style:{"margin-bottom":"20px"}}),p("div",ca,[t(Ie,{checkedKeys:b.value,"onUpdate:checkedKeys":e[8]||(e[8]=i=>b.value=i),expandedKeys:V.value,"onUpdate:expandedKeys":e[9]||(e[9]=i=>V.value=i),"tree-data":Y.value,checkable:"","field-names":{title:"title",key:"key",children:"children"},selectable:!1},null,8,["checkedKeys","expandedKeys","tree-data"])])])]),_:1},8,["open","title"]),t(Q,{open:R.value,"onUpdate:open":e[11]||(e[11]=i=>R.value=i),title:"批量删除进度",width:500,closable:C.value!=="active",maskClosable:!1,keyboard:!1},{footer:l(()=>[C.value!=="active"?(k(),K(o,{key:0,type:"primary",onClick:Me},{default:l(()=>e[43]||(e[43]=[u(" 关闭 ")])),_:1,__:[43]})):(k(),$("span",ka," 删除中，请勿关闭窗口... "))]),default:l(()=>[p("div",va,[t(W,{message:"正在删除角色，请稍候...",type:C.value==="exception"?"warning":"info","show-icon":"",style:{"margin-bottom":"20px"}},null,8,["type"]),p("div",fa,[t(Re,{percent:L.value,status:C.value,"stroke-color":{"0%":"#667eea","100%":"#764ba2"}},null,8,["percent","status"])]),p("div",ya,[p("span",null,"进度："+w(N.value)+" / "+w(j.value),1),p("span",_a,"成功："+w(S.value),1),p("span",ga,"失败："+w(M.value),1)]),C.value!=="active"?(k(),$("div",ha,[C.value==="success"?(k(),K(Z,{key:0,status:"success",title:"批量删除完成","sub-title":`成功删除 ${S.value} 个角色`,style:{padding:"20px 0 0 0"}},null,8,["sub-title"])):(k(),K(Z,{key:1,status:"warning",title:"批量删除完成","sub-title":`成功 ${S.value} 个，失败 ${M.value} 个`,style:{padding:"20px 0 0 0"}},null,8,["sub-title"]))])):ie("",!0)])]),_:1},8,["open","closable"])])}}}),Sa=Ne(ba,[["__scopeId","data-v-6795c12f"]]);export{Sa as default};
