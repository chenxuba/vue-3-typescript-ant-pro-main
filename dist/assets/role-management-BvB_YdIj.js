import{g as He,u as ue,d as de,c as Je}from"./role-kJYPnPgf.js";import{q as Y,_ as je}from"./index-CFZkWOU_.js";import{z as Qe,I as We,S as Ge,H as Xe,K as Ye,ab as Ze,af as ea,an as aa,a6 as ta,ai as la,ah as na,M as Z,y as sa,ak as oa,aw as ia,X as ra,a1 as f,al as ce}from"./antd-Cme2pY03.js";import{d as ua,r as pe,f as c,w as me,o as da,_ as $,a1 as b,$ as v,k as s,a7 as o,G as d,a9 as w,u as ve,a6 as F,ac as fe,l as ye}from"./vue-PnzzEkKE.js";const ca={class:"role-management"},pa={class:"content-wrapper"},ma={class:"main-panel"},va={class:"query-form"},fa={class:"table-header"},ya={class:"table-info"},ha={class:"info-value"},_a={class:"table-actions"},ga={class:"table-container"},ka={key:0,class:"role-link"},ba={key:1},Ca={key:2},wa={key:3},Ta={style:{padding:"20px 0"}},Aa={style:{"max-height":"400px",overflow:"auto",padding:"10px",background:"#fafafa","border-radius":"4px"}},xa={style:{padding:"20px 0"}},Sa={style:{"margin-bottom":"16px"}},Ea={style:{display:"flex","justify-content":"space-between",color:"#666","font-size":"14px"}},Ma={style:{color:"#52c41a"}},$a={style:{color:"#f5222d"}},Ia={key:0,style:{"margin-top":"16px","text-align":"center",color:"#666"}},Ka={key:1,style:{color:"#999","font-size":"12px"}},Ra=ua({name:"RoleManagement",__name:"role-management",setup(Na){const he=a=>{if(!a)return"-";const e=new Date(typeof a=="number"?a:parseInt(a));if(isNaN(e.getTime()))return"-";const n=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0"),r=String(e.getHours()).padStart(2,"0"),p=String(e.getMinutes()).padStart(2,"0"),y=String(e.getSeconds()).padStart(2,"0");return`${n}-${t}-${l} ${r}:${p}:${y}`},h=pe({name:"",page:1,limit:20,orderbyFiled:"name:desc"}),V=c(!1),ee=c([]),L=c(0),x=c([]),S=c([]),_e=[{title:"角色名称",dataIndex:"name",key:"name"},{title:"角色编码",dataIndex:"code",key:"code"},{title:"管理范围",dataIndex:"authTypeContent",key:"authTypeContent"},{title:"创建时间",dataIndex:"createTime",key:"createTime"},{title:"备注",dataIndex:"remark",key:"remark",ellipsis:!0},{title:"操作",key:"action",width:220,fixed:"right"}],R=c(!1),H=c(!1),J=c("新建角色"),z=c(!1),U=c(void 0),N=c(!1),j=c(!1),_=c(null),g=c([]),q=c([]),D=c(!1),Q=c(0),W=c(0),O=c(0),E=c(0),M=c(0),C=c("active"),i=pe({name:"",code:"",isAdmin:void 0,authType:void 0,authTypeContent:void 0,remark:""}),T=async()=>{V.value=!0;try{const a={page:h.page,limit:h.limit,orderbyFiled:h.orderbyFiled};h.name&&h.name.trim()&&(a.name=h.name);const e=await He(a);e.data&&(ee.value=e.data.list,L.value=e.data.total)}catch{f.error("获取角色列表失败")}finally{V.value=!1}},ae=()=>{h.page=1,x.value=[],S.value=[],T()},ge=()=>{h.name="",h.page=1,h.limit=20,h.orderbyFiled="name:desc",x.value=[],S.value=[],T()},ke=(a,e)=>{x.value=a,S.value=e},be=a=>({disabled:a.code==="admin"}),Ce=()=>{J.value="新建角色",z.value=!1,U.value=void 0,i.name="",i.code="",i.isAdmin=void 0,i.authType=void 0,i.authTypeContent=void 0,i.remark="",R.value=!0},we=a=>{if(a.code==="admin"){f.warning("admin 角色不允许编辑");return}J.value="编辑角色",z.value=!0,U.value=a.roleId||a.id,i.name=a.name||a.roleName||"",i.code=a.code||"",i.isAdmin=a.isAdmin,i.authType=a.authType,i.authTypeContent=a.authTypeContent,i.remark=a.remark||"",R.value=!0},Te=async()=>{H.value=!0;try{if(z.value&&U.value){if(!i.name||!i.code||i.isAdmin===void 0||i.authType===void 0||!i.authTypeContent){f.error("请填写所有必填项");return}await ue({roleId:U.value,name:i.name,code:i.code,isAdmin:i.isAdmin,authType:i.authType,authTypeContent:i.authTypeContent,remark:i.remark}),f.success("更新成功")}else{if(!i.name||!i.code||i.isAdmin===void 0||i.authType===void 0||!i.authTypeContent){f.error("请填写所有必填项");return}await Je({name:i.name,code:i.code,isAdmin:i.isAdmin,authType:i.authType,authTypeContent:i.authTypeContent,remark:i.remark}),f.success("创建成功")}R.value=!1,T()}catch{f.error(z.value?"更新失败":"创建失败")}finally{H.value=!1}},Ae=()=>{const a={};return Y.forEach(e=>{var n;(n=e.meta)!=null&&n.access&&Array.isArray(e.meta.access)&&(a[e.path]=e.meta.access),e.children&&e.children.length>0&&e.children.forEach(t=>{var l;(l=t.meta)!=null&&l.access&&Array.isArray(t.meta.access)&&(a[t.path]=t.meta.access)})}),a},xe=()=>{const a={};return Y.forEach(e=>{var n;(n=e.meta)!=null&&n.access&&Array.isArray(e.meta.access)&&e.meta.access.forEach(t=>{a[t]||(a[t]=[]),a[t].includes(e.path)||a[t].push(e.path)}),e.children&&e.children.length>0&&e.children.forEach(t=>{var l;(l=t.meta)!=null&&l.access&&Array.isArray(t.meta.access)&&t.meta.access.forEach(r=>{a[r]||(a[r]=[]),a[r].includes(t.path)||a[r].push(t.path)})})}),a},Se=()=>{const a=[];return Y.forEach(e=>{var t,l;if((t=e.meta)!=null&&t.hideInMenu)return;const n={key:e.path,title:((l=e.meta)==null?void 0:l.title)||e.name,children:[]};e.children&&e.children.length>0&&e.children.filter(p=>{var y,m;return(y=e.meta)!=null&&y.hideChildrenInMenu?!1:!((m=p.meta)!=null&&m.hideInMenu)}).forEach(p=>{var y;n.children.push({key:p.path,title:((y=p.meta)==null?void 0:y.title)||p.name})}),a.push(n)}),a},Ee=Ae(),Me=xe(),I=c(Se()),G=c([]),P=c({}),te=()=>{const a={},e=(n,t)=>{n.forEach(l=>{var r;a[l.key]={parentKey:t,childrenKeys:((r=l.children)==null?void 0:r.map(p=>p.key))||[]},l.children&&l.children.length>0&&e(l.children,l.key)})};e(I.value,null),P.value=a},le=a=>{const e=P.value[a];if(!e)return[];const n=[];return e.childrenKeys.forEach(t=>{n.push(t),n.push(...le(t))}),n},$e=a=>{var t,l;const e=[];let n=a;for(;(t=P.value[n])!=null&&t.parentKey;){const r=(l=P.value[n])==null?void 0:l.parentKey;if(!r)break;e.push(r),n=r}return e},B=()=>{const a=new Set,e=new Set(g.value),n=t=>{const l=e.has(t.key);if(!t.children||t.children.length===0)return{checked:l,partial:!1};let r=0,p=!1,y=!1;t.children.forEach(X=>{const A=n(X);A.checked&&r++,A.partial&&(p=!0),(A.checked||A.partial)&&(y=!0)});const m=r===t.children.length&&!p,K=!l&&y&&!m||p&&!l;return K&&a.add(t.key),{checked:l,partial:K}};I.value.forEach(t=>n(t)),G.value=Array.from(a)},Ie=(a,e)=>{$e(a).forEach(t=>{var p;const l=((p=P.value[t])==null?void 0:p.childrenKeys)||[];if(l.length===0)return;l.every(y=>e.has(y))?e.add(t):e.delete(t)})},Ke=(a,e)=>{var p;const n=(p=e==null?void 0:e.node)==null?void 0:p.key;if(!n)return;const t=e.checked,l=new Set(g.value),r=le(n);t?(l.add(n),r.forEach(y=>l.add(y))):(l.delete(n),r.forEach(y=>l.delete(y))),Ie(n,l),g.value=Array.from(l),B()},Re=()=>{const a=new Set(g.value),e=n=>{n.forEach(t=>{t.children&&t.children.length>0&&(e(t.children),t.children.every(r=>a.has(r.key))?a.add(t.key):a.delete(t.key))})};e(I.value),g.value=Array.from(a)};te(),B(),me(I,()=>{te(),B()},{deep:!0}),me(g,()=>{B()},{deep:!0});const ne=(a=[])=>{const e=[];return a.forEach(n=>{var t;n!=null&&n.key&&e.push(n.key),(t=n==null?void 0:n.children)!=null&&t.length&&e.push(...ne(n.children))}),e},Ne=a=>{if(!a)return[];const e=t=>t.map(l=>typeof l=="string"?l:String(l)).map(l=>l.trim()).filter(l=>!!l);if(Array.isArray(a))return e(a);const n=a.trim();if(!n)return[];if(n.startsWith("[")&&n.endsWith("]"))try{const t=JSON.parse(n);if(Array.isArray(t))return e(t)}catch(t){console.warn("解析 authMenus JSON 失败:",t);const l=n.slice(1,-1);if(l)return e(l.split(/[,，]/).map(r=>r.replace(/^["']|["']$/g,"")))}return e(n.split(/[,，]/).map(t=>t.replace(/^["']|["']$/g,"")))},De=async a=>{if(a.code==="admin"){f.warning("admin 角色不允许修改权限");return}if(_.value=a,N.value=!0,q.value=ne(I.value),a.authMenus){const e=Ne(a.authMenus),n=new Set;e.forEach(t=>{const l=Me[t.trim()];l&&Array.isArray(l)&&l.forEach(r=>n.add(r))}),g.value=Array.from(n),Re(),console.log("角色权限标识:",e),console.log("转换后的路由路径:",g.value)}else g.value=[]},Pe=async()=>{var a;if(((a=_.value)==null?void 0:a.code)==="admin"){f.warning("admin 角色不允许修改权限");return}j.value=!0;try{const e=new Set;g.value.forEach(l=>{const r=Ee[l];r&&Array.isArray(r)&&r.forEach(p=>e.add(p))});const n=Array.from(e).join(",");console.log("当前角色对象:",_.value),console.log("选中的路由路径:",g.value),console.log("对应的权限标识:",n);const t={roleId:_.value.roleId||_.value.id,name:_.value.name||_.value.roleName,isAdmin:_.value.isAdmin,authType:_.value.authType,authTypeContent:_.value.authTypeContent,remark:_.value.remark,authMenus:n};console.log("提交的参数:",t),await ue(t),f.success("权限保存成功"),N.value=!1,T()}catch(e){console.error("权限保存失败:",e),f.error("权限保存失败")}finally{j.value=!1}},ze=()=>{N.value=!1,g.value=[],q.value=[],G.value=[],_.value=null},Ue=a=>{if(a.code==="admin"){f.warning("admin 角色不允许删除");return}Z.confirm({title:"确认删除",icon:ye(ce),content:`确定要删除角色"${a.name||a.roleName}"吗？`,okText:"确定",cancelText:"取消",onOk:async()=>{try{await de(a.roleId||a.id),f.success("删除成功"),T()}catch{f.error("删除失败")}}})},qe=()=>{if(x.value.length===0){f.warning("请选择要删除的角色");return}const a=S.value.filter(e=>e.code!=="admin");if(a.length===0){f.warning("所选角色中包含 admin 角色，不允许删除");return}a.length<S.value.length&&f.warning("admin 角色不允许删除，将跳过该角色"),Z.confirm({title:"确认批量删除",icon:ye(ce),content:`确定要删除选中的 ${a.length} 个角色吗？`,okText:"确定",cancelText:"取消",onOk:async()=>{await Oe(a)}})},Oe=async(a=S.value)=>{const e=a.length;W.value=e,O.value=0,Q.value=0,E.value=0,M.value=0,C.value="active",D.value=!0;for(let n=0;n<a.length;n++){const t=a[n];O.value=n+1;try{await de(t.roleId||t.id),E.value++}catch(l){M.value++,console.error(`删除角色 ${t.name||t.roleName} 失败:`,l)}Q.value=Math.floor(O.value/W.value*100)}C.value=M.value>0?"exception":"success",setTimeout(()=>{D.value=!1,E.value>0?(f.success(`成功删除 ${E.value} 个角色${M.value>0?`，失败 ${M.value} 个`:""}`),x.value=[],S.value=[],T()):f.error("批量删除失败")},1500)},Be=()=>{C.value!=="active"&&(D.value=!1)},Fe=a=>{h.page=a.current,h.limit=a.pageSize,T()};return da(()=>{T()}),(a,e)=>{var ie;const n=We,t=Qe,l=Xe,r=Ge,p=Ye,y=aa,m=la,K=ta,X=na,A=Z,se=sa,Ve=oa,Le=ia,oe=ra;return b(),$("div",ca,[v("div",pa,[v("div",ma,[e[21]||(e[21]=v("div",{class:"query-header"},[v("h3",null,"筛选查询")],-1)),v("div",va,[s(p,{layout:"inline"},{default:o(()=>[s(t,{label:"角色名称"},{default:o(()=>[s(n,{value:h.name,"onUpdate:value":e[0]||(e[0]=u=>h.name=u),placeholder:"请输入","allow-clear":"",style:{width:"200px"},onPressEnter:ae},null,8,["value"])]),_:1}),s(t,null,{default:o(()=>[s(r,null,{default:o(()=>[s(l,{type:"primary",onClick:ae},{default:o(()=>e[11]||(e[11]=[d(" 查询 ")])),_:1,__:[11]}),s(l,{onClick:ge},{default:o(()=>e[12]||(e[12]=[d(" 重置 ")])),_:1,__:[12]})]),_:1})]),_:1})]),_:1})]),v("div",fa,[v("div",ya,[e[13]||(e[13]=v("span",{class:"info-label"},"数据列表",-1)),e[14]||(e[14]=v("span",{class:"info-divider"},"数据共",-1)),v("span",ha,w(L.value),1),e[15]||(e[15]=v("span",{class:"info-unit"},"条",-1))]),v("div",_a,[s(l,{type:"primary",onClick:Ce},{icon:o(()=>[s(ve(Ze))]),default:o(()=>[e[16]||(e[16]=d(" 新建角色 "))]),_:1,__:[16]}),s(l,{danger:"",disabled:x.value.length===0,onClick:qe},{icon:o(()=>[s(ve(ea))]),default:o(()=>[e[17]||(e[17]=d(" 批量删除 "))]),_:1,__:[17]},8,["disabled"])])]),v("div",ga,[s(y,{columns:_e,"data-source":ee.value,loading:V.value,pagination:{current:h.page,pageSize:h.limit,total:L.value,showSizeChanger:!0,showQuickJumper:!0,showTotal:u=>`共 ${u} 条`},"row-selection":{selectedRowKeys:x.value,onChange:ke,getCheckboxProps:be},scroll:{x:1e3},"row-key":u=>u.roleId||u.id,onChange:Fe},{bodyCell:o(({column:u,record:k})=>[u.key==="name"?(b(),$("a",ka,w(k.name||k.roleName),1)):u.key==="code"?(b(),$("span",ba,w(k.code||"-"),1)):u.key==="createTime"?(b(),$("span",Ca,w(he(k.createTime)),1)):u.key==="remark"?(b(),$("span",wa,w(k.remark||"-"),1)):u.key==="action"?(b(),F(r,{key:4},{default:o(()=>[s(l,{type:"link",size:"small",disabled:k.code==="admin",onClick:re=>we(k)},{default:o(()=>e[18]||(e[18]=[d(" 编辑 ")])),_:2,__:[18]},1032,["disabled","onClick"]),s(l,{type:"link",size:"small",disabled:k.code==="admin",onClick:re=>De(k)},{default:o(()=>e[19]||(e[19]=[d(" 权限管理 ")])),_:2,__:[19]},1032,["disabled","onClick"]),s(l,{type:"link",size:"small",danger:"",disabled:k.code==="admin",onClick:re=>Ue(k)},{default:o(()=>e[20]||(e[20]=[d(" 删除 ")])),_:2,__:[20]},1032,["disabled","onClick"])]),_:2},1024)):fe("",!0)]),_:1},8,["data-source","loading","pagination","row-selection","row-key"])])])]),s(A,{open:R.value,"onUpdate:open":e[7]||(e[7]=u=>R.value=u),title:J.value,width:600,"confirm-loading":H.value,onOk:Te},{default:o(()=>[s(p,{model:i,"label-col":{span:8},"wrapper-col":{span:14},style:{"margin-top":"24px"}},{default:o(()=>[s(t,{label:"角色名称",name:"name",rules:[{required:!0,message:"请输入角色名称",trigger:"blur"}]},{default:o(()=>[s(n,{value:i.name,"onUpdate:value":e[1]||(e[1]=u=>i.name=u),placeholder:"请输入角色名称","allow-clear":""},null,8,["value"])]),_:1}),s(t,{label:"角色编码",name:"code",rules:[{required:!0,message:"请输入角色编码",trigger:"blur"}]},{default:o(()=>[s(n,{value:i.code,"onUpdate:value":e[2]||(e[2]=u=>i.code=u),placeholder:"请输入角色编码","allow-clear":""},null,8,["value"])]),_:1}),s(t,{label:"是否虚拟机构管理员角色",name:"isAdmin",rules:[{required:!0,message:"请选择",trigger:"change"}]},{default:o(()=>[s(K,{value:i.isAdmin,"onUpdate:value":e[3]||(e[3]=u=>i.isAdmin=u),placeholder:"请选择","allow-clear":""},{default:o(()=>[s(m,{value:1},{default:o(()=>e[22]||(e[22]=[d("是")])),_:1,__:[22]}),s(m,{value:0},{default:o(()=>e[23]||(e[23]=[d("否")])),_:1,__:[23]})]),_:1},8,["value"])]),_:1}),s(t,{label:"管理范围类型",name:"authType",rules:[{required:!0,message:"请选择管理范围类型",trigger:"change"}]},{default:o(()=>[s(K,{value:i.authType,"onUpdate:value":e[4]||(e[4]=u=>i.authType=u),placeholder:"请选择","allow-clear":""},{default:o(()=>[s(m,{value:0},{default:o(()=>e[24]||(e[24]=[d("全部数据")])),_:1,__:[24]}),s(m,{value:1},{default:o(()=>e[25]||(e[25]=[d("本单位及下属单位")])),_:1,__:[25]}),s(m,{value:2},{default:o(()=>e[26]||(e[26]=[d("仅本单位")])),_:1,__:[26]}),s(m,{value:3},{default:o(()=>e[27]||(e[27]=[d("本部门及下属部门")])),_:1,__:[27]}),s(m,{value:4},{default:o(()=>e[28]||(e[28]=[d("仅本部门")])),_:1,__:[28]}),s(m,{value:5},{default:o(()=>e[29]||(e[29]=[d("指定范围")])),_:1,__:[29]})]),_:1},8,["value"])]),_:1}),s(t,{label:"管理范围",name:"authTypeContent",rules:[{required:!0,message:"请选择管理范围",trigger:"change"}]},{default:o(()=>[s(K,{value:i.authTypeContent,"onUpdate:value":e[5]||(e[5]=u=>i.authTypeContent=u),placeholder:"请选择","allow-clear":""},{default:o(()=>[s(m,{value:"全部"},{default:o(()=>e[30]||(e[30]=[d("全部")])),_:1,__:[30]}),s(m,{value:"计算机网络信息中心"},{default:o(()=>e[31]||(e[31]=[d("计算机网络信息中心")])),_:1,__:[31]}),s(m,{value:"大数据技术与应用发展部"},{default:o(()=>e[32]||(e[32]=[d("大数据技术与应用发展部")])),_:1,__:[32]}),s(m,{value:"高性能计算技术与应用发展部"},{default:o(()=>e[33]||(e[33]=[d("高性能计算技术与应用发展部")])),_:1,__:[33]}),s(m,{value:"网络安全部"},{default:o(()=>e[34]||(e[34]=[d("网络安全部")])),_:1,__:[34]}),s(m,{value:"系统运维部"},{default:o(()=>e[35]||(e[35]=[d("系统运维部")])),_:1,__:[35]}),s(m,{value:"技术研发部"},{default:o(()=>e[36]||(e[36]=[d("技术研发部")])),_:1,__:[36]}),s(m,{value:"综合管理部"},{default:o(()=>e[37]||(e[37]=[d("综合管理部")])),_:1,__:[37]}),s(m,{value:"人力资源部"},{default:o(()=>e[38]||(e[38]=[d("人力资源部")])),_:1,__:[38]}),s(m,{value:"财务部"},{default:o(()=>e[39]||(e[39]=[d("财务部")])),_:1,__:[39]})]),_:1},8,["value"])]),_:1}),s(t,{label:"备注"},{default:o(()=>[s(X,{value:i.remark,"onUpdate:value":e[6]||(e[6]=u=>i.remark=u),placeholder:"请输入备注",rows:3,"allow-clear":""},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","title","confirm-loading"]),s(A,{open:N.value,"onUpdate:open":e[9]||(e[9]=u=>N.value=u),title:`${((ie=_.value)==null?void 0:ie.roleName)||""}角色权限编辑`,width:600,maskClosable:!1},{footer:o(()=>[s(l,{onClick:ze},{default:o(()=>e[40]||(e[40]=[d("取消")])),_:1,__:[40]}),s(l,{type:"primary",loading:j.value,onClick:Pe},{default:o(()=>e[41]||(e[41]=[d(" 保存 ")])),_:1,__:[41]},8,["loading"])]),default:o(()=>[v("div",Ta,[s(se,{message:"请选择该角色可以访问的功能模块",type:"info","show-icon":"",style:{"margin-bottom":"20px"}}),v("div",Aa,[s(Ve,{checkedKeys:{checked:g.value,halfChecked:G.value},expandedKeys:q.value,"onUpdate:expandedKeys":e[8]||(e[8]=u=>q.value=u),"tree-data":I.value,checkable:"",checkStrictly:!0,"field-names":{title:"title",key:"key",children:"children"},selectable:!1,onCheck:Ke},null,8,["checkedKeys","expandedKeys","tree-data"])])])]),_:1},8,["open","title"]),s(A,{open:D.value,"onUpdate:open":e[10]||(e[10]=u=>D.value=u),title:"批量删除进度",width:500,closable:C.value!=="active",maskClosable:!1,keyboard:!1},{footer:o(()=>[C.value!=="active"?(b(),F(l,{key:0,type:"primary",onClick:Be},{default:o(()=>e[42]||(e[42]=[d(" 关闭 ")])),_:1,__:[42]})):(b(),$("span",Ka," 删除中，请勿关闭窗口... "))]),default:o(()=>[v("div",xa,[s(se,{message:"正在删除角色，请稍候...",type:C.value==="exception"?"warning":"info","show-icon":"",style:{"margin-bottom":"20px"}},null,8,["type"]),v("div",Sa,[s(Le,{percent:Q.value,status:C.value,"stroke-color":{"0%":"#667eea","100%":"#764ba2"}},null,8,["percent","status"])]),v("div",Ea,[v("span",null,"进度："+w(O.value)+" / "+w(W.value),1),v("span",Ma,"成功："+w(E.value),1),v("span",$a,"失败："+w(M.value),1)]),C.value!=="active"?(b(),$("div",Ia,[C.value==="success"?(b(),F(oe,{key:0,status:"success",title:"批量删除完成","sub-title":`成功删除 ${E.value} 个角色`,style:{padding:"20px 0 0 0"}},null,8,["sub-title"])):(b(),F(oe,{key:1,status:"warning",title:"批量删除完成","sub-title":`成功 ${E.value} 个，失败 ${M.value} 个`,style:{padding:"20px 0 0 0"}},null,8,["sub-title"]))])):fe("",!0)])]),_:1},8,["open","closable"])])}}}),qa=je(Ra,[["__scopeId","data-v-661f135d"]]);export{qa as default};
