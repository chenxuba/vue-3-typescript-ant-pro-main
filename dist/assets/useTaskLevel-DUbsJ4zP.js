import{d as J,_ as P,a1 as U,$,a6 as B,a7 as k,k as C,a9 as G,B as Fe,u as z,F as te,G as O,f as L,y as Te,w as se,n as xe,ag as ce,an as $e,ac as ie,ab as Ie,c as Y,l as ae}from"./vue-PnzzEkKE.js";import{ad as Ae,ak as Se,D as qe,u as Le,f as Ve,e as Me,c as Re,H as Z,K as le,z as oe,I as re,M as H,al as Ue,am as Ne,ab as De,ah as Ke,a1 as p}from"./antd-Cme2pY03.js";import{_ as W}from"./index-CTId23k1.js";import{R as Ee,u as Pe}from"./RichTextEditor-CLMA0qC-.js";import{h as de,i as Oe,j as Qe,k as je,l as Be,m as He,b as ue,d as ze}from"./index-DtajCZ6D.js";const Ge={class:"file-tree-container"},Je={class:"tree-content"},We={class:"tree-node-title-wrapper"},Xe={class:"tree-node-title"},Ye={key:0,class:"folder-icon"},Ze={key:1,class:"file-icon"},et=["title"],tt=J({__name:"FileTreeComponent",props:{fileTreeData:{},expandedKeys:{}},emits:["update:expandedKeys","select","menu-click","expand"],setup(h,{emit:v}){const l=v,A=y=>{l("update:expandedKeys",y)},c=(y,r)=>{l("select",y,r)},s=(y,r)=>{l("menu-click",y,r)},g=(y,r)=>{l("expand",y,r)};return(y,r)=>{const _=Ae,w=Me,D=Re,K=Ve,Q=qe,q=Se;return U(),P("div",Ge,[r[10]||(r[10]=$("div",{class:"tree-header"},[$("span",{class:"tree-title"},"文件目录")],-1)),$("div",Je,[!y.fileTreeData||y.fileTreeData.length===0?(U(),B(_,{key:0,description:"暂无文件",class:"empty-tree"},{image:k(()=>r[1]||(r[1]=[$("div",{class:"empty-icon"},"📂",-1)])),_:1})):(U(),B(q,{key:1,"expanded-keys":y.expandedKeys,"onUpdate:expandedKeys":A,"tree-data":y.fileTreeData,"show-icon":!1,"show-line":!0,onSelect:c,onExpand:g},{title:k(({title:T,isLeaf:V,children:E,key:j})=>[$("span",We,[$("span",Xe,[E!==void 0||V===!1?(U(),P("span",Ye,"📁")):(U(),P("span",Ze,"📄")),$("span",{class:"tree-node-text",title:T},G(T),9,et)]),C(Q,{trigger:["click"],placement:"bottomRight"},{overlay:k(()=>[C(K,{onClick:n=>s(n,{key:j,title:T,isLeaf:V,children:E})},{default:k(()=>[E!==void 0||V===!1?(U(),P(te,{key:0},[C(w,{key:"newFile"},{default:k(()=>r[2]||(r[2]=[$("span",null,"新建文件",-1)])),_:1,__:[2]}),C(w,{key:"newFolder"},{default:k(()=>r[3]||(r[3]=[$("span",null,"新建文件夹",-1)])),_:1,__:[3]}),C(w,{key:"upload"},{default:k(()=>r[4]||(r[4]=[$("span",null,"上传",-1)])),_:1,__:[4]}),C(D),C(w,{key:"copyPath"},{default:k(()=>r[5]||(r[5]=[$("span",null,"复制路径",-1)])),_:1,__:[5]}),C(w,{key:"delete",danger:""},{default:k(()=>r[6]||(r[6]=[$("span",null,"删除",-1)])),_:1,__:[6]})],64)):(U(),P(te,{key:1},[C(w,{key:"rename"},{default:k(()=>r[7]||(r[7]=[$("span",null,"重命名",-1)])),_:1,__:[7]}),C(w,{key:"copyPath"},{default:k(()=>r[8]||(r[8]=[$("span",null,"复制路径",-1)])),_:1,__:[8]}),C(w,{key:"delete",danger:""},{default:k(()=>r[9]||(r[9]=[$("span",null,"删除",-1)])),_:1,__:[9]})],64))]),_:2},1032,["onClick"])]),default:k(()=>[$("span",{class:"tree-node-more",onClick:r[0]||(r[0]=Fe(()=>{},["stop"]))},[C(z(Le))])]),_:2},1024)])]),_:1},8,["expanded-keys","tree-data"]))])])}}}),Lt=W(tt,[["__scopeId","data-v-5b6e9659"]]),st={class:"file-preview-area"},nt={key:0,class:"file-preview"},at={class:"file-header"},lt={class:"file-name"},ot={class:"file-content"},rt={class:"download-container"},it={key:1,class:"empty-preview"},ut=J({__name:"FilePreview",props:{selectedFile:{},highlightedCode:{},dynamicFileContents:{}},setup(h){const v=h,l=()=>{var s;const c=v.selectedFile;if(c){if(c.fileUrl){const g=`http://101.200.13.193${c.fileUrl}`,y=document.createElement("a");y.href=g,y.download=c.title,y.target="_blank",document.body.appendChild(y),y.click(),document.body.removeChild(y),console.log("下载文件:",g)}else if(c.content||v.dynamicFileContents&&v.dynamicFileContents[c.key]){const g=c.content||((s=v.dynamicFileContents)==null?void 0:s[c.key])||"",y=new Blob([g],{type:"text/plain;charset=utf-8"}),r=URL.createObjectURL(y),_=document.createElement("a");_.href=r,_.download=c.title,document.body.appendChild(_),_.click(),document.body.removeChild(_),URL.revokeObjectURL(r),console.log("下载本地文件:",c.title)}}},A=()=>{const c=v.selectedFile;return c?!!(c.fileUrl||c.content||v.dynamicFileContents&&v.dynamicFileContents[c.key]):!1};return(c,s)=>{const g=Z;return U(),P("div",st,[c.selectedFile?(U(),P("div",nt,[$("div",at,[s[0]||(s[0]=$("span",{class:"file-icon"},"📄",-1)),$("span",lt,G(c.selectedFile.title),1)]),$("div",ot,[$("div",rt,[C(g,{type:"primary",size:"large",disabled:!A(),onClick:l},{default:k(()=>s[1]||(s[1]=[O(" 点击下载 ")])),_:1,__:[1]},8,["disabled"])])])])):(U(),P("div",it," 在左侧代码仓库区域点击目录打开文件 "))])}}}),Vt=W(ut,[["__scopeId","data-v-8acd7451"]]);function ct(){const h=L([1]);return{codeLineNumbers:h,updateLineNumbers:c=>{const s=c.split(`
`).length;h.value=Array.from({length:Math.max(s,1)},(g,y)=>y+1)},syncScroll:c=>{var y;const s=c.target,g=(y=s.parentElement)==null?void 0:y.querySelector(".code-editor-line-numbers");g&&(g.scrollTop=s.scrollTop)},handleKeydown:(c,s,g)=>{if(c.key==="Tab"){c.preventDefault();const y=c.target,r=y.selectionStart,_=y.selectionEnd,w=s,D=w.substring(0,r)+"  "+w.substring(_);g(D),Te(()=>{y.selectionStart=y.selectionEnd=r+2})}}}}const dt={class:"min-w-100px max-w-150px"},pt={class:"code-editor-wrapper"},mt={class:"code-editor-line-numbers"},ft={class:"modal-footer"},vt=J({__name:"NewFileModal",props:{open:{type:Boolean},parentPath:{}},emits:["update:open","confirm"],setup(h,{emit:v}){const l=h,A=v,c=L(),s=L({fileName:"",commitMessage:"",fileContent:""}),g={fileName:[{required:!0,message:"请输入文件名称",trigger:"blur"}],commitMessage:[{required:!0,message:"请输入提交信息",trigger:"blur"}],fileContent:[{required:!0,message:"请输入文件内容",trigger:"blur"}]},{codeLineNumbers:y,updateLineNumbers:r,syncScroll:_,handleKeydown:w}=ct();se(()=>s.value.fileContent,q=>{r(q)});const D=()=>{var q;A("update:open",!1),(q=c.value)==null||q.resetFields()},K=async()=>{var q,T;try{await((q=c.value)==null?void 0:q.validate()),A("confirm",{...s.value}),(T=c.value)==null||T.resetFields()}catch(V){console.error("表单验证失败：",V)}},Q=q=>{w(q,s.value.fileContent,T=>{s.value.fileContent=T})};return se(()=>l.open,q=>{var T;q&&(s.value={fileName:"",commitMessage:"",fileContent:""},y.value=[1],(T=c.value)==null||T.clearValidate())}),(q,T)=>{const V=re,E=oe,j=le,n=Z,t=H;return U(),B(t,{open:q.open,title:"新建文件",footer:null,width:"880px",centered:"","onUpdate:open":T[4]||(T[4]=i=>q.$emit("update:open",i))},{default:k(()=>[C(j,{ref_key:"formRef",ref:c,model:s.value,rules:g,layout:"vertical"},{default:k(()=>[C(E,{label:"文件名称或文件路径：",name:"fileName",required:""},{default:k(()=>[C(V,{value:s.value.fileName,"onUpdate:value":T[0]||(T[0]=i=>s.value.fileName=i),placeholder:"请输入文件名称"},{addonBefore:k(()=>[$("div",dt,G(q.parentPath),1)]),_:1},8,["value"])]),_:1}),C(E,{label:"提交信息：",name:"commitMessage",required:""},{default:k(()=>[C(V,{value:s.value.commitMessage,"onUpdate:value":T[1]||(T[1]=i=>s.value.commitMessage=i),placeholder:"请输入本次提交的主要信息，合理的描信息有利于代历史记录的查理"},null,8,["value"])]),_:1}),C(E,{label:"文件内容：",name:"fileContent",required:""},{default:k(()=>[$("div",pt,[$("div",mt,[(U(!0),P(te,null,ce(z(y),i=>(U(),P("div",{key:i,class:"line-number"},G(i),1))),128))]),xe($("textarea",{"onUpdate:modelValue":T[2]||(T[2]=i=>s.value.fileContent=i),class:"code-editor-textarea",placeholder:"请输入文件内容",onScroll:T[3]||(T[3]=(...i)=>z(_)&&z(_)(...i)),onKeydown:Q,spellcheck:"false"},null,544),[[$e,s.value.fileContent]])])]),_:1})]),_:1},8,["model"]),$("div",ft,[C(n,{onClick:D},{default:k(()=>T[5]||(T[5]=[O("取消")])),_:1,__:[5]}),C(n,{type:"primary",onClick:K},{default:k(()=>T[6]||(T[6]=[O("确定")])),_:1,__:[6]})])]),_:1},8,["open"])}}}),Mt=W(vt,[["__scopeId","data-v-8bf29398"]]),gt={class:"min-w-100px max-w-150px"},yt={class:"modal-footer"},ht=J({__name:"NewFolderModal",props:{open:{type:Boolean},parentPath:{}},emits:["update:open","confirm"],setup(h,{emit:v}){const l=h,A=v,c=L(),s=L({folderName:"",commitMessage:""}),g={folderName:[{required:!0,message:"请输入文件夹名称",trigger:"blur"}],commitMessage:[{required:!0,message:"请输入提交信息",trigger:"blur"}]},y=()=>{var _;A("update:open",!1),(_=c.value)==null||_.resetFields()},r=async()=>{var _,w;try{await((_=c.value)==null?void 0:_.validate()),A("confirm",{...s.value}),(w=c.value)==null||w.resetFields()}catch(D){console.error("表单验证失败：",D)}};return se(()=>l.open,_=>{var w;_&&(s.value={folderName:"",commitMessage:""},(w=c.value)==null||w.clearValidate())}),(_,w)=>{const D=re,K=oe,Q=le,q=Z,T=H;return U(),B(T,{open:_.open,title:"新建文件夹",footer:null,width:"600px",centered:"","onUpdate:open":w[2]||(w[2]=V=>_.$emit("update:open",V))},{default:k(()=>[C(Q,{ref_key:"formRef",ref:c,model:s.value,rules:g,layout:"vertical"},{default:k(()=>[C(K,{label:"文件夹名称：",name:"folderName",required:""},{default:k(()=>[C(D,{value:s.value.folderName,"onUpdate:value":w[0]||(w[0]=V=>s.value.folderName=V),placeholder:"请输入文件夹名称"},{addonBefore:k(()=>[$("div",gt,G(_.parentPath),1)]),_:1},8,["value"])]),_:1}),C(K,{label:"提交信息：",name:"commitMessage",required:""},{default:k(()=>[C(D,{value:s.value.commitMessage,"onUpdate:value":w[1]||(w[1]=V=>s.value.commitMessage=V),placeholder:"请输入本次提交的主要信息，合理的描信息有利于代历史记录的查理"},null,8,["value"])]),_:1})]),_:1},8,["model"]),$("div",yt,[C(q,{onClick:y},{default:k(()=>w[3]||(w[3]=[O("取消")])),_:1,__:[3]}),C(q,{type:"primary",onClick:r},{default:k(()=>w[4]||(w[4]=[O("确定")])),_:1,__:[4]})])]),_:1},8,["open"])}}}),Rt=W(ht,[["__scopeId","data-v-81b8c3fd"]]),_t={class:"repository-modal-content"},wt={class:"modal-icon"},kt={class:"modal-footer"},Ct=J({__name:"RepositoryModal",props:{open:{type:Boolean}},emits:["update:open","confirm","cancel"],setup(h,{emit:v}){const l=v,A=()=>{l("confirm")},c=()=>{l("cancel")};return(s,g)=>{const y=Z,r=H;return U(),B(r,{open:s.open,title:"开启代码库",footer:null,width:"480px",centered:"","onUpdate:open":g[0]||(g[0]=_=>s.$emit("update:open",_))},{default:k(()=>[$("div",_t,[$("div",wt,[C(z(Ue),{style:{color:"#faad14","font-size":"24px"}})]),g[1]||(g[1]=$("div",{class:"modal-text"}," 新建实践题关卡时，需要使用代码仓库；如果只有选择关卡，则不需要代码仓库。代码仓库启用后，将无法关闭。 ",-1))]),$("div",kt,[C(y,{onClick:c},{default:k(()=>g[2]||(g[2]=[O("不开启")])),_:1,__:[2]}),C(y,{type:"primary",onClick:A},{default:k(()=>g[3]||(g[3]=[O("开启")])),_:1,__:[3]})])]),_:1},8,["open"])}}}),Ut=W(Ct,[["__scopeId","data-v-a8bbff12"]]),bt={class:"ai-buttons-bar"},Ft={class:"options-list"},Tt=["onClick"],xt=J({__name:"QuestionModal",props:{open:{type:Boolean},question:{},projectId:{},taskId:{},existingQuestions:{}},emits:["update:open","confirm"],setup(h,{emit:v}){const l=h,A=v,c=L(),s=L({id:"",name:"",options:[{id:"1",label:"A",content:"",isCorrect:!1},{id:"2",label:"B",content:"",isCorrect:!1},{id:"3",label:"C",content:"",isCorrect:!1},{id:"4",label:"D",content:"",isCorrect:!1}],answerKey:""}),y={name:[{required:!0,message:"请输入题干"},{validator:(n,t)=>!t||!t.replace(/<[^>]*>/g,"").trim()?Promise.reject("请输入内容"):Promise.resolve()}],answerKey:[{required:!0,message:"请输入答案解析",trigger:"blur"}]},r=n=>{let t=[];try{t=JSON.parse(n.selects||"[]").map((f,I)=>{const x=Object.keys(f)[0];return{id:(I+1).toString(),label:x,content:f[x],isCorrect:n.answer.includes(x)}})}catch{t=[{id:"1",label:"A",content:"",isCorrect:!1},{id:"2",label:"B",content:"",isCorrect:!1},{id:"3",label:"C",content:"",isCorrect:!1},{id:"4",label:"D",content:"",isCorrect:!1}]}return{id:n.id,name:n.name,options:t,answerKey:n.answerKey}};se(()=>l.open,n=>{n&&(l.question?s.value=r(l.question):s.value={id:Date.now().toString(),name:"",options:[{id:"1",label:"A",content:"",isCorrect:!1},{id:"2",label:"B",content:"",isCorrect:!1},{id:"3",label:"C",content:"",isCorrect:!1},{id:"4",label:"D",content:"",isCorrect:!1}],answerKey:""})});const _=()=>{var n;A("update:open",!1),(n=c.value)==null||n.resetFields()},w=n=>{var I,x;const t=n.options.filter(m=>m.content.trim()).map(m=>({[m.label]:m.content})),i=n.options.filter(m=>m.isCorrect).map(m=>m.label).join(",");let f=1;return l.question&&l.question.weight?f=l.question.weight:l.existingQuestions&&l.existingQuestions.length>0&&(f=Math.max(...l.existingQuestions.map(S=>S.weight||0))+1),{id:n.id,name:n.name,answer:i,answerKey:n.answerKey,selects:JSON.stringify(t),projectId:l.projectId||((I=l.question)==null?void 0:I.projectId),taskId:l.taskId||((x=l.question)==null?void 0:x.taskId),weight:f}},D=async()=>{var n,t,i,f;try{if(await((n=c.value)==null?void 0:n.validate()),!s.value.options.some(b=>b.content.trim())){p.error("请至少填写一个选项");return}if(!s.value.options.some(b=>b.isCorrect)){p.error("请至少设置一个正确答案");return}if(!l.projectId){p.error("项目ID不存在");return}if(!l.taskId){p.error("任务关卡ID不存在，请先保存任务关卡");return}const m=w(s.value),S=l.question&&l.question.id;console.log("=== 题目参数 ==="),console.log("操作模式:",S?"编辑":"新增"),console.log("题目ID (id):",m.id),console.log("题目数据:",m),console.log("项目ID (projectId):",m.projectId),console.log("任务ID (taskId):",m.taskId),console.log("排序权重 (weight):",m.weight),console.log("已有题目数量:",((t=l.existingQuestions)==null?void 0:t.length)||0),console.log("==================");try{if(S){console.log("编辑模式：调用更新接口");const b=await de({id:parseInt(m.id),name:m.name,answer:m.answer,answerKey:m.answerKey,selects:m.selects,projectId:m.projectId,taskId:m.taskId,weight:m.weight});console.log("题目更新成功，返回数据:",b),p.success("题目更新成功"),A("confirm",m),A("update:open",!1),(i=c.value)==null||i.resetFields()}else{const b=await Oe({name:m.name,answer:m.answer,answerKey:m.answerKey,selects:m.selects,projectId:m.projectId,taskId:m.taskId,weight:m.weight});console.log("题目创建成功，返回数据:",b),p.success("题目创建成功"),m.id=b.id.toString(),A("confirm",m),A("update:open",!1),(f=c.value)==null||f.resetFields()}}catch(b){console.error(S?"题目更新失败:":"题目创建失败:",b),p.error(b.message||(S?"题目更新失败，请重试":"题目创建失败，请重试"))}}catch{p.error("请完善必填信息")}},K=n=>{s.value.options.forEach(i=>{i.isCorrect=!1});const t=s.value.options.find(i=>i.id===n);t&&(t.isCorrect=!0)},Q=n=>{if(s.value.options.length<=2){p.warning("至少保留2个选项");return}const t=s.value.options.findIndex(i=>i.id===n);t!==-1&&(s.value.options.splice(t,1),s.value.options.forEach((i,f)=>{i.label=String.fromCharCode(65+f)}))},q=()=>{if(s.value.options.length>=10){p.warning("最多添加10个选项");return}const n=String.fromCharCode(65+s.value.options.length);s.value.options.push({id:Date.now().toString(),label:n,content:"",isCorrect:!1})},T=L(!1),V=L(!1),E=async()=>{if(!s.value.name){p.warning("请先输入题干内容");return}if(!s.value.name.replace(/<[^>]*>/g,"").trim()){p.warning("请先输入题干内容");return}try{V.value=!0,p.loading("AI正在润色题干，请稍候...",0);const t=await Qe(s.value.name);p.destroy(),s.value.name=t,p.success("AI润色成功")}catch(t){p.destroy(),console.error("AI润色失败:",t),p.error(t.message||"AI润色失败，请重试")}finally{V.value=!1}},j=async()=>{if(!s.value.name){p.warning("请先输入题干内容");return}if(!s.value.name.replace(/<[^>]*>/g,"").trim()){p.warning("请先输入题干内容");return}try{T.value=!0,p.loading("AI正在生成题目，请稍候...",0);const t=await je(s.value.name);if(p.destroy(),console.log("=== AI出题返回数据 ==="),console.log("返回结果:",t),t.title&&(s.value.name=t.title),t.options&&Array.isArray(t.options)&&t.options.length>0){const i=t.options.map((f,I)=>{const x=String.fromCharCode(65+I);return{id:(I+1).toString(),label:x,content:f,isCorrect:!1}});s.value.options=i}if(t.answer){const i=t.answer.split(",").map(f=>f.trim());s.value.options.forEach(f=>{f.isCorrect=i.includes(f.label)})}t.analysis&&(s.value.answerKey=t.analysis),p.success("AI出题成功")}catch(t){p.destroy(),console.error("AI出题失败:",t),p.error(t.message||"AI出题失败，请重试")}finally{T.value=!1}};return(n,t)=>{const i=Z,f=oe,I=re,x=Ke,m=le,S=H;return U(),B(S,{open:n.open,title:n.question?"编辑题目":"添加题目",width:"900px","mask-closable":!1,onCancel:_},{footer:k(()=>[C(i,{onClick:_},{default:k(()=>t[5]||(t[5]=[O("取消")])),_:1,__:[5]}),C(i,{type:"primary",onClick:D},{default:k(()=>t[6]||(t[6]=[O("保存")])),_:1,__:[6]})]),default:k(()=>[C(m,{ref_key:"formRef",ref:c,model:s.value,rules:y,layout:"vertical"},{default:k(()=>[C(f,{label:"题干",name:"name",required:""},{default:k(()=>[$("div",bt,[C(i,{type:"primary",onClick:j,loading:T.value,size:"small"},{default:k(()=>t[2]||(t[2]=[O(" AI出题 ")])),_:1,__:[2]},8,["loading"]),C(i,{type:"primary",onClick:E,loading:V.value,size:"small"},{default:k(()=>t[3]||(t[3]=[O(" AI润色 ")])),_:1,__:[3]},8,["loading"])]),C(Ee,{modelValue:s.value.name,"onUpdate:modelValue":t[0]||(t[0]=b=>s.value.name=b),placeholder:"请您输入题干",height:150,"show-ai-embellish":!1},null,8,["modelValue"])]),_:1}),C(f,{required:""},{label:k(()=>t[4]||(t[4]=[$("span",null,[O("答案选项 "),$("span",{class:"options-hint ml-12px"},"点击字母设置正确答案（单选）")],-1)])),default:k(()=>[$("div",Ft,[(U(!0),P(te,null,ce(s.value.options,b=>(U(),P("div",{key:b.id,class:"option-item"},[$("div",{class:Ie(["option-label",{"is-correct":b.isCorrect}]),onClick:N=>K(b.id)},G(b.label),11,Tt),C(I,{value:b.content,"onUpdate:value":N=>b.content=N,placeholder:"请输入选项内容",class:"option-input"},null,8,["value","onUpdate:value"]),s.value.options.length>2?(U(),B(z(Ne),{key:0,class:"remove-icon",onClick:N=>Q(b.id)},null,8,["onClick"])):ie("",!0),b.id===s.value.options[s.value.options.length-1].id&&s.value.options.length<10?(U(),B(z(De),{key:1,class:"add-icon",onClick:q})):ie("",!0)]))),128))])]),_:1}),C(f,{label:"答案解析",name:"answerKey",required:""},{default:k(()=>[C(x,{value:s.value.answerKey,"onUpdate:value":t[1]||(t[1]=b=>s.value.answerKey=b),placeholder:"请输入答案解析",rows:1},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","title"])}}}),Nt=W(xt,[["__scopeId","data-v-403b19b6"]]);function Dt(){const h=L([]),v=L([]),l=L(null),A=L({}),c=L({}),s=n=>A.value[n]?A.value[n]:`// 文件内容加载中...
// 请从Git仓库加载文件`,g=n=>{var f;const t=(f=n.split(".").pop())==null?void 0:f.toLowerCase();return{vue:"vue",js:"javascript",ts:"typescript",html:"html",css:"css",json:"json",md:"markdown"}[t||""]||"javascript"},y=(n,t)=>{var m;if(n.length===0||!t.node)return;const i=t.node;if(!i.isLeaf)return;const f=n[0],I=i.title,x=((m=i.dataRef)==null?void 0:m.fileUrl)||i.fileUrl;l.value={key:f,title:I,content:"",fileUrl:x||null},console.log("选中文件:",{key:f,title:I,fileUrl:x})},r=Y(()=>""),_=n=>{const t=(i,f,I="")=>{for(const x of i){const m=I+"/"+x.title;if(x.key===f)return m;if(x.children){const S=t(x.children,f,m);if(S)return S}}return null};return t(h.value,n)||"/"},w=(n,t,i)=>{const f=`0-new-file-${Date.now()}`,I={title:n,key:f,isLeaf:!0};A.value[f]=t;const x=i==="/"?n:`${i.replace(/^\//,"")}/${n}`;if(c.value[f]=x,i==="/")h.value.push(I);else{const m=(S,b)=>{for(const N of S){const ee=c.value[N.key]||_(N.key);if(ee===b||ee===b.replace(/^\//,""))return N.children||(N.children=[]),N.children.push(I),v.value.includes(N.key)||v.value.push(N.key),!0;if(N.children&&m(N.children,b))return!0}return!1};m(h.value,i)}},D=(n,t)=>{const i=`0-new-folder-${Date.now()}`,f={title:n,key:i,isLeaf:!1,children:[]},I=t==="/"?n:`${t.replace(/^\//,"")}/${n}`;if(c.value[i]=I,t==="/")h.value.push(f);else{const x=(m,S)=>{for(const b of m){const N=c.value[b.key]||_(b.key);if(N===S||N===S.replace(/^\//,""))return b.children||(b.children=[]),b.children.push(f),v.value.includes(b.key)||v.value.push(b.key),!0;if(b.children&&x(b.children,S))return!0}return!1};x(h.value,t)}v.value.push(i)},K=n=>{H.confirm({title:"重命名",content:ae("div",[ae("p",`当前名称：${n.title}`),ae("input",{id:"rename-input",placeholder:"请输入新名称",style:"width: 100%; padding: 4px 11px; border: 1px solid #d9d9d9; border-radius: 2px;"})]),onOk:()=>{const t=document.getElementById("rename-input"),i=t==null?void 0:t.value.trim();if(!i)return p.error("请输入新名称"),Promise.reject();const f=I=>{for(const x of I){if(x.key===n.key)return x.title=i,p.success("重命名成功"),!0;if(x.children&&f(x.children))return!0}return!1};f(h.value),l.value&&l.value.key===n.key&&(l.value.title=i)}})},Q=n=>{const t=_(n.key);navigator.clipboard.writeText(t).then(()=>{p.success(`路径已复制到剪贴板: ${t}`)}).catch(()=>{p.error("复制失败")})},q=n=>{const t=n.children!==void 0||n.isLeaf===!1;H.confirm({title:"确认删除",content:`确定要删除${t?"文件夹":"文件"} "${n.title}" 吗？${t?"文件夹下的所有内容也会被删除。":""}`,okText:"确定",cancelText:"取消",okType:"danger",onOk:()=>{const i=f=>{var x;const I=f.findIndex(m=>m.key===n.key);if(I!==-1)return f.splice(I,1),p.success("删除成功"),((x=l.value)==null?void 0:x.key)===n.key&&(l.value=null),A.value[n.key]&&delete A.value[n.key],!0;for(const m of f)if(m.children&&i(m.children))return!0;return!1};i(h.value)}})},T=(n,t="0",i="")=>!n||!Array.isArray(n)?(console.warn("convertApiDataToTreeNodes: apiData is not an array",n),[]):n.map((f,I)=>{const x=`${t}-${I}`,m=i?`${i}/${f.fileName}`:f.fileName,S={title:f.fileName||"untitled",key:x,fileUrl:f.fileUrl||null};return c.value[x]=m,f.fileType==="dir"?(S.isLeaf=!1,S.children=[]):S.isLeaf=!0,S});return{fileTreeData:h,expandedKeys:v,selectedFile:l,dynamicFileContents:A,highlightedCode:r,getFileContent:s,getLanguageByFilename:g,handleSelectFile:y,getNodePath:_,addFileToTree:w,addFolderToTree:D,handleRenameNode:K,handleCopyPath:Q,handleDeleteNode:q,loadRemoteFileTree:n=>{try{console.log("加载远程文件树，原始数据:",n),c.value={},A.value={};const t=T(n,"0","");console.log("转换后的树节点:",t),h.value=t,v.value=[],l.value=null}catch(t){console.error("加载文件树失败:",t),h.value=[]}},loadChildrenData:(n,t)=>{try{console.log("加载子文件夹数据:",{nodeKey:n,apiData:t});const i=c.value[n]||"",f=T(t,n,i);console.log("转换后的子节点:",f);const I=m=>{for(const S of m){if(S.key===n)return S.children=f,!0;if(S.children&&I(S.children))return!0}return!1};I(h.value)||console.warn("未找到对应的节点进行更新:",n)}catch(i){console.error("加载子文件夹失败:",i)}},getNodePathFromMap:n=>c.value[n]||""}}function Kt(h){const v=L([]),l=L(""),A=L("task"),c=L(),s=L(),g=L({name:"",source:"",require:"",referenceAnswer:"",difficulty:2,tag:"",classHour:"",jumpUrl:"",type:1,projectId:(h==null?void 0:h.value)||void 0,weight:0}),y=L([]),r=L({timeLimitM:0,userFiles:[],testValidateFiles:[],testValidateSh:"",passType:1,passTypeRule:"",blankCode:1,scoreRule:1,testValidateType:1,testContent:[]}),_=L([]),w=L([]),D=(o,e)=>!e||!e.replace(/<[^>]*>/g,"").trim()?Promise.reject("请输入内容"):Promise.resolve(),K={name:[{required:!0,message:"请输入任务名称",trigger:"blur"}],source:[{required:!0,message:"请上传学习资源",trigger:"change"}],require:[{required:!0,message:""},{validator:D}],referenceAnswer:[{required:!0,message:""},{validator:D}],difficulty:[{required:!0,message:"请选择难度系数",trigger:"change"}],tag:[{required:!0,message:"请输入技能标签",trigger:"blur"}],classHour:[{required:!0,message:"请输入任务学时",trigger:"blur"}],jumpUrl:[{required:!0,message:"请输入内嵌链接",trigger:"blur"}]},Q={timeLimitM:[{required:!0,message:"请输入评测时长限制",trigger:"blur"}],userFiles:[{required:!0,message:"请上传学员任务文件",trigger:"change",type:"array",min:1}],testValidateFiles:[{required:!0,message:"请上传评测执行文件",trigger:"change",type:"array",min:1}],testValidateSh:[{required:!0,message:"请输入评测执行命令",trigger:"blur"}]},q=Y(()=>{if(!l.value)return!1;const o=v.value.find(e=>e.id===l.value);return(o==null?void 0:o.type)==="kernel"}),T=Y(()=>{if(!l.value)return!1;const o=v.value.find(e=>e.id===l.value);return(o==null?void 0:o.type)==="choice"}),V=Y(()=>{if(!l.value)return!1;const o=v.value.find(e=>e.id===l.value);return(o==null?void 0:o.type)==="programming"}),E=o=>{if(v.value.some(F=>!F.taskId)){p.warning("请先保存当前未保存的任务关卡，再添加新关卡");return}if(l.value){const F=v.value.find(R=>R.id===l.value);if(F&&F.taskId){if(F.type==="choice"&&(!F.questions||F.questions.length===0)){p.warning("请至少新增一条题目"),A.value="questions";return}if(F.type==="programming"&&(!F.evaluationSettings||!F.evaluationSettings.testContent||F.evaluationSettings.testContent.length===0)){p.warning("请先配置评测设置后再添加新关卡"),A.value="evaluation";return}}}const a={programming:"编程实训任务关卡",choice:"选择题实训任务关卡",kernel:"内核链接实训任务关卡"},u=v.value.reduce((F,R)=>Math.max(F,R.weight||0),0),d={id:Date.now().toString(),name:`第${v.value.length+1}关：${a[o]}`,type:o,source:"",require:"",referenceAnswer:"",difficulty:2,tag:"",classHour:"",weight:u+1};v.value.push(d),l.value=d.id,A.value="task",t(d.id),p.success("任务关卡添加成功")},j=o=>{var a;const e=v.value.findIndex(u=>u.id===o);e!==-1&&(v.value.splice(e,1),v.value.forEach((u,d)=>{const F=u.name.match(/^第\d+关：(.+)$/);if(F)u.name=`第${d+1}关：${F[1]}`;else{const R=u.name.indexOf("：");if(R!==-1){const X=u.name.substring(R+1);u.name=`第${d+1}关：${X}`}else u.name=`第${d+1}关：${u.name}`}}),l.value===o&&(l.value=((a=v.value[0])==null?void 0:a.id)||""),l.value&&t(l.value),p.success("任务关卡删除成功"))},n=async o=>{l.value&&l.value!==o&&i(l.value),l.value=o,A.value="task",t(o);const e=v.value.find(a=>a.id===o);e&&e.type==="choice"&&e.taskId&&await ne(e.taskId)},t=o=>{const e=v.value.find(a=>a.id===o);if(e){if(e.source){const u=e.source.split(",").filter(d=>d.trim());y.value=u.map((d,F)=>{const R=d.trim();return{uid:`${Date.now()}-${F}`,name:R.substring(R.lastIndexOf("/")+1),status:"done",url:R}})}else y.value=[];const a={programming:1,choice:2,kernel:4};g.value={name:e.name,source:e.source||"",require:e.require,referenceAnswer:e.referenceAnswer,difficulty:e.difficulty,tag:e.tag,classHour:e.classHour,jumpUrl:e.jumpUrl||"",type:a[e.type]||3,projectId:(h==null?void 0:h.value)||void 0,taskId:e.taskId,weight:e.weight||0},e.evaluationSettings?(r.value={...e.evaluationSettings},e.evaluationSettings.userFiles&&Array.isArray(e.evaluationSettings.userFiles)?_.value=e.evaluationSettings.userFiles:_.value=[],e.evaluationSettings.testValidateFiles&&Array.isArray(e.evaluationSettings.testValidateFiles)?w.value=e.evaluationSettings.testValidateFiles:w.value=[]):(r.value={timeLimitM:0,userFiles:[],testValidateFiles:[],testValidateSh:"",passType:1,passTypeRule:"",blankCode:1,scoreRule:1,testValidateType:1,testContent:[]},_.value=[],w.value=[])}},i=o=>{const e=v.value.find(a=>a.id===o);if(e){const a=e.questions;e.source=g.value.source,e.require=g.value.require,e.referenceAnswer=g.value.referenceAnswer,e.difficulty=g.value.difficulty,e.tag=g.value.tag,e.classHour=g.value.classHour,e.jumpUrl=g.value.jumpUrl,e.weight=g.value.weight||0,g.value.taskId&&(e.taskId=g.value.taskId),e.questions=a,e.evaluationSettings={...r.value}}},f=async o=>{const{file:e,onSuccess:a,onError:u}=o;try{const d=await Pe(e);a({url:d},e)}catch(d){u(d)}},I=o=>{var d;const{file:e,fileList:a}=o;e.status==="done"?p.success(`${e.name} 文件上传成功`):e.status==="error"&&p.error(`${e.name} 文件上传失败`),y.value=a.map(F=>{var R;return{uid:F.uid,name:F.name,status:F.status,url:((R=F.response)==null?void 0:R.url)||F.url||""}});const u=y.value.filter(F=>F.url).map(F=>F.url).join(",");g.value.source=u,(d=c.value)==null||d.validateFields(["source"])},x=async()=>{var o,e,a;try{if(q.value||T.value)await((o=c.value)==null?void 0:o.validate());else if(V.value){if(await Promise.all([(e=c.value)==null?void 0:e.validate(),(a=s.value)==null?void 0:a.validate()]),g.value.taskId&&r.value.testValidateType===1&&r.value.testContent.length===0)throw p.error("用例类型为文本时，必须至少创建一条测试集"),new Error("用例类型为文本时，必须至少创建一条测试集");if(g.value.taskId&&r.value.testValidateType===1&&r.value.testContent.length>0&&r.value.testContent.find(R=>!R.arg.trim()||!R.answer.trim()))throw p.error("测试集的输入内容和期望输出不能为空"),new Error("测试集的输入内容和期望输出不能为空")}let u={...g.value};if(V.value){const F=r.value.testContent.map(M=>({arg:M.arg,answer:M.answer,select:M.select})),R=r.value.userFiles.filter(M=>M.url).map(M=>M.url).join(","),X=r.value.testValidateFiles.filter(M=>M.url).map(M=>M.url).join(",");u={...u,timeLimitM:r.value.timeLimitM,userFiles:R,testValidateFiles:X,passType:r.value.passType,passTypeRule:r.value.passTypeRule,blankCode:r.value.blankCode,scoreRule:r.value.scoreRule,testValidateSh:r.value.testValidateSh,testValidateType:r.value.testValidateType,testContent:JSON.stringify(F)}}console.log("准备提交的数据:",u);let d;g.value.taskId?(d=await ue({...u,taskId:g.value.taskId}),console.log("任务关卡更新成功，返回数据:",d),p.success("更新成功")):(d=await ze(u),console.log("任务关卡创建成功，返回数据:",d),d.taskId&&(g.value.taskId=d.taskId,console.log("已保存 taskId:",d.taskId)),p.success("保存成功")),l.value&&i(l.value)}catch(u){throw console.error("保存任务关卡失败:",u),p.error("请完善必填信息"),u}},m=async()=>{l.value&&(i(l.value),console.log("已同步当前选中关卡的表单数据到本地状态"));const o=v.value.filter(a=>a.taskId);if(o.length===0){console.log("没有需要更新的任务关卡");return}console.log(`开始批量更新 ${o.length} 个任务关卡`);const e=[];for(const a of o)try{let u={taskId:a.taskId,name:a.name,source:a.source,require:a.require,referenceAnswer:a.referenceAnswer,difficulty:a.difficulty,tag:a.tag,classHour:a.classHour,jumpUrl:a.jumpUrl,projectId:(h==null?void 0:h.value)||void 0,weight:a.weight||0};if(a.type==="kernel")u.type=4;else if(a.type==="choice")u.type=2;else if(a.type==="programming"&&(u.type=1,a.evaluationSettings)){const d=a.evaluationSettings,F=d.testContent.map(M=>({arg:M.arg,answer:M.answer,select:M.select})),R=d.userFiles.filter(M=>M.url).map(M=>M.url).join(","),X=d.testValidateFiles.filter(M=>M.url).map(M=>M.url).join(",");u={...u,timeLimitM:d.timeLimitM,userFiles:R,testValidateFiles:X,passType:d.passType,passTypeRule:d.passTypeRule,blankCode:d.blankCode,scoreRule:d.scoreRule,testValidateSh:d.testValidateSh,testValidateType:d.testValidateType,testContent:JSON.stringify(F)}}await ue(u),console.log(`任务关卡 "${a.name}" 更新成功`)}catch(u){const d=`任务关卡 "${a.name}" 更新失败: ${u.message||"未知错误"}`;console.error(d,u),e.push(d)}if(e.length===0)p.success(`成功更新 ${o.length} 个任务关卡`);else throw e.length<o.length?(p.warning(`部分任务关卡更新失败：${e.join("; ")}`),new Error("部分任务关卡更新失败")):(p.error("所有任务关卡更新失败"),new Error("所有任务关卡更新失败"))},S=()=>{H.confirm({title:"确认重置",content:"确定要重置表单吗？所有未保存的数据将会丢失。",okText:"确定",cancelText:"取消",onOk:()=>{var e,a;let o=1;if(l.value){const u=v.value.find(d=>d.id===l.value);u&&(o={programming:1,choice:2,kernel:4}[u.type]||1)}g.value={name:"",source:"",require:"",referenceAnswer:"",difficulty:2,tag:"",classHour:"",jumpUrl:"",type:o,projectId:(h==null?void 0:h.value)||void 0,weight:0},r.value={timeLimitM:0,userFiles:[],testValidateFiles:[],testValidateSh:"",passType:1,passTypeRule:"",blankCode:1,scoreRule:1,testValidateType:1,testContent:[]},y.value=[],_.value=[],w.value=[],(e=c.value)==null||e.clearValidate(),(a=s.value)==null||a.clearValidate(),p.success("已重置")}})},b=o=>{var u;const{file:e,fileList:a}=o;e.status==="done"?p.success(`${e.name} 文件上传成功`):e.status==="error"&&p.error(`${e.name} 文件上传失败`),_.value=a.map(d=>{var F;return{uid:d.uid,name:d.name,status:d.status,url:((F=d.response)==null?void 0:F.url)||d.url||""}}),r.value.userFiles=[..._.value],(u=s.value)==null||u.validateFields(["userFiles"])},N=o=>{var u;const{file:e,fileList:a}=o;e.status==="done"?p.success(`${e.name} 文件上传成功`):e.status==="error"&&p.error(`${e.name} 文件上传失败`),w.value=a.map(d=>{var F;return{uid:d.uid,name:d.name,status:d.status,url:((F=d.response)==null?void 0:F.url)||d.url||""}}),r.value.testValidateFiles=[...w.value],(u=s.value)==null||u.validateFields(["testValidateFiles"])},ee=o=>{var a;const e=o.map((u,d)=>({uid:`${Date.now()}-${d}`,name:u.name,status:"done",url:u.path}));_.value=e,r.value.userFiles=[..._.value],(a=s.value)==null||a.validateFields(["userFiles"]),p.success(`已选择 ${o.length} 个文件`)},pe=o=>{var a;const e=o.map((u,d)=>({uid:`${Date.now()}-${d}`,name:u.name,status:"done",url:u.path}));w.value=e,r.value.testValidateFiles=[...w.value],(a=s.value)==null||a.validateFields(["testValidateFiles"]),p.success(`已选择 ${o.length} 个文件`)},me=()=>{r.value.testContent.push({id:Date.now().toString(),arg:"",answer:"",select:1})},fe=o=>{const e=r.value.testContent.findIndex(a=>a.id===o);e!==-1&&(r.value.testContent.splice(e,1),p.success("删除成功"))},ve=()=>{r.value.testContent=[],p.success("已清空所有测试用例")},ge=()=>{p.info("下载功能开发中...")},ye=()=>{p.info("批量上传功能开发中...")},he=Y(()=>{if(!l.value)return[];const o=v.value.find(e=>e.id===l.value);return(o==null?void 0:o.questions)||[]}),_e=o=>{if(!l.value)return;const e=v.value.find(a=>a.id===l.value);e&&(e.questions||(e.questions=[]),e.questions.push(o),p.success("题目添加成功"))},we=async o=>{l.value&&H.confirm({title:"确认删除",content:"确定要删除这道题目吗？删除后无法恢复。",okText:"确定",cancelText:"取消",async onOk(){try{console.log("开始删除题目，ID:",o),await He({id:parseInt(o)}),console.log("题目删除成功"),p.success("题目删除成功");const e=v.value.find(a=>a.id===l.value);if(e&&e.questions){const a=e.questions.findIndex(u=>u.id===o);a!==-1&&e.questions.splice(a,1)}e&&e.taskId&&await ne(e.taskId)}catch(e){console.error("题目删除失败:",e),p.error(e.message||"题目删除失败，请重试")}}})},ke=o=>{if(!l.value)return;const e=v.value.find(a=>a.id===l.value);if(e&&e.questions){const a=e.questions.findIndex(u=>u.id===o.id);a!==-1&&(e.questions[a]=o,p.success("题目更新成功"))}},Ce=o=>{if(!l.value)return;const e=v.value.find(a=>a.id===l.value);e&&(e.questions=o)},be=async o=>{if(!(h!=null&&h.value))throw new Error("项目ID不存在");try{console.log("批量更新题目排序，共",o.length,"个题目");const e=o.map(a=>de({id:parseInt(a.id),name:a.name,answer:a.answer,answerKey:a.answerKey,selects:a.selects,projectId:a.projectId||h.value,taskId:a.taskId,weight:a.weight}));await Promise.all(e),console.log("题目排序保存成功")}catch(e){throw console.error("保存题目排序失败:",e),e}},ne=async o=>{if(!(h!=null&&h.value)){console.error("项目ID不存在");return}try{console.log("开始加载题目列表，参数:",{projectId:h.value,taskId:o});const e=await Be({projectId:h.value,taskId:o});console.log("题目列表加载成功:",e);const a=e.map(u=>({id:u.id.toString(),name:u.name,answer:u.answer,answerKey:u.answerKey,selects:u.selects,projectId:u.projectId,taskId:u.taskId,weight:u.weight})).sort((u,d)=>(u.weight||0)-(d.weight||0));if(l.value){const u=v.value.find(d=>d.id===l.value);u&&(u.questions=a,console.log("题目列表已更新到任务关卡:",u.name,"题目数量:",a.length))}}catch(e){console.error("加载题目列表失败:",e),p.error(e.message||"加载题目列表失败")}};return{taskLevels:v,selectedTaskLevelId:l,currentTab:A,taskLevelFormRef:c,evaluationFormRef:s,taskLevelFormData:g,evaluationFormData:r,learningResourceFileList:y,taskLevelFormRules:K,evaluationFormRules:Q,isKernelTask:q,isChoiceTask:T,isProgrammingTask:V,addTaskLevel:E,deleteTaskLevel:j,selectTaskLevel:n,saveTaskLevel:x,saveAllTaskLevels:m,resetTaskLevel:S,handleLearningResourceCustomRequest:f,handleLearningResourceUpload:I,handleUserFilesUpload:b,handleTestValidateFilesUpload:N,handleUserFilesSelect:ee,handleTestValidateFilesSelect:pe,userFileList:_,testValidateFileList:w,addTestCase:me,removeTestCase:fe,clearAllTestCases:ve,downloadTemplate:ge,batchUploadTestCases:ye,getCurrentQuestions:he,addQuestion:_e,deleteQuestion:we,updateQuestion:ke,updateQuestionsOrder:Ce,loadQuestions:ne,saveQuestionsOrder:be}}export{Lt as F,Mt as N,Nt as Q,Ut as R,Kt as a,Vt as b,Rt as c,Dt as u};
