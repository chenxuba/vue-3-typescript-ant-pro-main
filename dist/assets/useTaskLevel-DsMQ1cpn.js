import{R as ue,u as ce}from"./RichTextEditor-DLxZnIKk.js";import{h as W,i as de,j as ve,k as me,d as fe,b as pe}from"./index-j719aqKG.js";import{a0 as ge,U as ye,V as he,am as ke,af as we,an as Ce,H as Te,M as H,a7 as i}from"./antd-BIZT1SGM.js";import{d as Fe,f as C,w as Ie,a6 as j,a1 as Q,a7 as V,k as L,$ as U,_ as E,F as _e,ah as be,ad as N,ac as qe,aa as xe,u as J,G as B,c as D}from"./vue-C8C4cLDH.js";import{_ as Ve}from"./index-Bov35lb3.js";const Le={class:"title-input-wrapper"},Se={class:"options-list"},Ae=["onClick"],Qe=Fe({__name:"QuestionModal",props:{open:{type:Boolean},question:{},projectId:{},taskId:{},existingQuestions:{}},emits:["update:open","confirm"],setup(g,{emit:f}){const a=g,T=f,F=C(),c=C({id:"",name:"",options:[{id:"1",label:"A",content:"",isCorrect:!1},{id:"2",label:"B",content:"",isCorrect:!1},{id:"3",label:"C",content:"",isCorrect:!1},{id:"4",label:"D",content:"",isCorrect:!1}],answerKey:""}),S={name:[{required:!0,message:"请输入题干"},{validator:(o,u)=>!u||!u.replace(/<[^>]*>/g,"").trim()?Promise.reject("请输入内容"):Promise.resolve()}],answerKey:[{required:!0,message:"请输入答案解析",trigger:"blur"}]},d=o=>{let u=[];try{u=JSON.parse(o.selects||"[]").map((h,b)=>{const k=Object.keys(h)[0];return{id:(b+1).toString(),label:k,content:h[k],isCorrect:o.answer.includes(k)}})}catch{u=[{id:"1",label:"A",content:"",isCorrect:!1},{id:"2",label:"B",content:"",isCorrect:!1},{id:"3",label:"C",content:"",isCorrect:!1},{id:"4",label:"D",content:"",isCorrect:!1}]}return{id:o.id,name:o.name,options:u,answerKey:o.answerKey}};Ie(()=>a.open,o=>{o&&(a.question?c.value=d(a.question):c.value={id:Date.now().toString(),name:"",options:[{id:"1",label:"A",content:"",isCorrect:!1},{id:"2",label:"B",content:"",isCorrect:!1},{id:"3",label:"C",content:"",isCorrect:!1},{id:"4",label:"D",content:"",isCorrect:!1}],answerKey:""})});const _=()=>{var o;T("update:open",!1),(o=F.value)==null||o.resetFields()},x=o=>{var b,k;const u=o.options.filter(r=>r.content.trim()).map(r=>({[r.label]:r.content})),p=o.options.filter(r=>r.isCorrect).map(r=>r.label).join(",");let h=1;return a.question&&a.question.weight?h=a.question.weight:a.existingQuestions&&a.existingQuestions.length>0&&(h=Math.max(...a.existingQuestions.map(q=>q.weight||0))+1),{id:o.id,name:o.name,answer:p,answerKey:o.answerKey,selects:JSON.stringify(u),projectId:a.projectId||((b=a.question)==null?void 0:b.projectId),taskId:a.taskId||((k=a.question)==null?void 0:k.taskId),weight:h}},R=async()=>{var o,u,p,h;try{if(await((o=F.value)==null?void 0:o.validate()),!c.value.options.some(v=>v.content.trim())){i.error("请至少填写一个选项");return}if(!c.value.options.some(v=>v.isCorrect)){i.error("请至少设置一个正确答案");return}if(!a.projectId){i.error("项目ID不存在");return}if(!a.taskId){i.error("任务关卡ID不存在，请先保存任务关卡");return}const r=x(c.value),q=a.question&&a.question.id;console.log("=== 题目参数 ==="),console.log("操作模式:",q?"编辑":"新增"),console.log("题目ID (id):",r.id),console.log("题目数据:",r),console.log("项目ID (projectId):",r.projectId),console.log("任务ID (taskId):",r.taskId),console.log("排序权重 (weight):",r.weight),console.log("已有题目数量:",((u=a.existingQuestions)==null?void 0:u.length)||0),console.log("==================");try{if(q){console.log("编辑模式：调用更新接口");const v=await W({id:parseInt(r.id),name:r.name,answer:r.answer,answerKey:r.answerKey,selects:r.selects,projectId:r.projectId,taskId:r.taskId,weight:r.weight});console.log("题目更新成功，返回数据:",v),i.success("题目更新成功"),T("confirm",r),T("update:open",!1),(p=F.value)==null||p.resetFields()}else{const v=await de({name:r.name,answer:r.answer,answerKey:r.answerKey,selects:r.selects,projectId:r.projectId,taskId:r.taskId,weight:r.weight});console.log("题目创建成功，返回数据:",v),i.success("题目创建成功"),r.id=v.id.toString(),T("confirm",r),T("update:open",!1),(h=F.value)==null||h.resetFields()}}catch(v){console.error(q?"题目更新失败:":"题目创建失败:",v),i.error(v.message||(q?"题目更新失败，请重试":"题目创建失败，请重试"))}}catch{i.error("请完善必填信息")}},K=o=>{c.value.options.forEach(p=>{p.isCorrect=!1});const u=c.value.options.find(p=>p.id===o);u&&(u.isCorrect=!0)},O=o=>{if(c.value.options.length<=2){i.warning("至少保留2个选项");return}const u=c.value.options.findIndex(p=>p.id===o);u!==-1&&(c.value.options.splice(u,1),c.value.options.forEach((p,h)=>{p.label=String.fromCharCode(65+h)}))},$=()=>{if(c.value.options.length>=10){i.warning("最多添加10个选项");return}const o=String.fromCharCode(65+c.value.options.length);c.value.options.push({id:Date.now().toString(),label:o,content:"",isCorrect:!1})};return(o,u)=>{const p=ye,h=he,b=Ce,k=ge,r=Te,q=H;return Q(),j(q,{open:o.open,title:o.question?"编辑题目":"添加题目",width:"900px","mask-closable":!1,onCancel:_},{footer:V(()=>[L(r,{onClick:_},{default:V(()=>u[3]||(u[3]=[B("取消")])),_:1,__:[3]}),L(r,{type:"primary",onClick:R},{default:V(()=>u[4]||(u[4]=[B("保存")])),_:1,__:[4]})]),default:V(()=>[L(k,{ref_key:"formRef",ref:F,model:c.value,rules:S,layout:"vertical"},{default:V(()=>[L(p,{label:"题干",name:"name",required:""},{default:V(()=>[U("div",Le,[L(ue,{modelValue:c.value.name,"onUpdate:modelValue":u[0]||(u[0]=v=>c.value.name=v),placeholder:"请您输入题干",height:150,class:"title-input"},null,8,["modelValue"])])]),_:1}),L(p,{required:""},{label:V(()=>u[2]||(u[2]=[U("span",null,[B("答案选项 "),U("span",{class:"options-hint ml-12px"},"点击字母设置正确答案（单选）")],-1)])),default:V(()=>[U("div",Se,[(Q(!0),E(_e,null,be(c.value.options,v=>(Q(),E("div",{key:v.id,class:"option-item"},[U("div",{class:qe(["option-label",{"is-correct":v.isCorrect}]),onClick:A=>K(v.id)},xe(v.label),11,Ae),L(h,{value:v.content,"onUpdate:value":A=>v.content=A,placeholder:"请输入选项内容",class:"option-input"},null,8,["value","onUpdate:value"]),c.value.options.length>2?(Q(),j(J(ke),{key:0,class:"remove-icon",onClick:A=>O(v.id)},null,8,["onClick"])):N("",!0),v.id===c.value.options[c.value.options.length-1].id&&c.value.options.length<10?(Q(),j(J(we),{key:1,class:"add-icon",onClick:$})):N("",!0)]))),128))])]),_:1}),L(p,{label:"答案解析",name:"answerKey",required:""},{default:V(()=>[L(b,{value:c.value.answerKey,"onUpdate:value":u[1]||(u[1]=v=>c.value.answerKey=v),placeholder:"请输入答案解析",rows:1},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","title"])}}}),Oe=Ve(Qe,[["__scopeId","data-v-9db87d10"]]);function Me(g){const f=C([]),a=C(""),T=C("task"),F=C(),c=C(),y=C({name:"",source:"",require:"",referenceAnswer:"",difficulty:2,tag:"",classHour:"",jumpUrl:"",type:1,projectId:(g==null?void 0:g.value)||void 0}),S=C([]),d=C({timeLimitM:0,userFiles:[],testValidateFiles:[],testValidateSh:"",passType:1,blankCode:1,scoreRule:1,testValidateType:1,testContent:[]}),_=C([]),x=C([]),R=(t,e)=>!e||!e.replace(/<[^>]*>/g,"").trim()?Promise.reject("请输入内容"):Promise.resolve(),K={name:[{required:!0,message:"请输入任务名称",trigger:"blur"}],source:[{required:!0,message:"请上传学习资源",trigger:"change"}],require:[{required:!0,message:""},{validator:R}],referenceAnswer:[{required:!0,message:""},{validator:R}],difficulty:[{required:!0,message:"请选择难度系数",trigger:"change"}],tag:[{required:!0,message:"请输入技能标签",trigger:"blur"}],classHour:[{required:!0,message:"请输入任务学时",trigger:"blur"}],jumpUrl:[{required:!0,message:"请输入内嵌链接",trigger:"blur"}]},O={timeLimitM:[{required:!0,message:"请输入评测时长限制",trigger:"blur"}],userFiles:[{required:!0,message:"请上传学员任务文件",trigger:"change",type:"array",min:1}],testValidateFiles:[{required:!0,message:"请上传评测执行文件",trigger:"change",type:"array",min:1}],testValidateSh:[{required:!0,message:"请输入评测执行命令",trigger:"blur"}]},$=D(()=>{if(!a.value)return!1;const t=f.value.find(e=>e.id===a.value);return(t==null?void 0:t.type)==="kernel"}),o=D(()=>{if(!a.value)return!1;const t=f.value.find(e=>e.id===a.value);return(t==null?void 0:t.type)==="choice"}),u=D(()=>{if(!a.value)return!1;const t=f.value.find(e=>e.id===a.value);return(t==null?void 0:t.type)==="programming"}),p=t=>{if(f.value.some(l=>!l.taskId)){i.warning("请先保存当前未保存的任务关卡，再添加新关卡");return}if(a.value){const l=f.value.find(m=>m.id===a.value);if(l&&l.taskId){if(l.type==="choice"&&(!l.questions||l.questions.length===0)){i.warning("请至少新增一条题目"),T.value="questions";return}if(l.type==="programming"&&(!l.evaluationSettings||!l.evaluationSettings.testContent||l.evaluationSettings.testContent.length===0)){i.warning("请先配置评测设置后再添加新关卡"),T.value="evaluation";return}}}const s={programming:"编程实训任务关卡",choice:"选择题实训任务关卡",kernel:"内核链接实训任务关卡"},n={id:Date.now().toString(),name:`第${f.value.length+1}关：${s[t]}`,type:t,source:"",require:"",referenceAnswer:"",difficulty:2,tag:"",classHour:""};f.value.push(n),a.value=n.id,T.value="task",k(n.id),i.success("任务关卡添加成功")},h=t=>{var s;const e=f.value.findIndex(n=>n.id===t);e!==-1&&(f.value.splice(e,1),f.value.forEach((n,l)=>{const m=n.name.match(/^第\d+关：(.+)$/);if(m)n.name=`第${l+1}关：${m[1]}`;else{const w=n.name.indexOf("：");if(w!==-1){const P=n.name.substring(w+1);n.name=`第${l+1}关：${P}`}else n.name=`第${l+1}关：${n.name}`}}),a.value===t&&(a.value=((s=f.value[0])==null?void 0:s.id)||""),a.value&&k(a.value),i.success("任务关卡删除成功"))},b=async t=>{a.value&&a.value!==t&&r(a.value),a.value=t,T.value="task",k(t);const e=f.value.find(s=>s.id===t);e&&e.type==="choice"&&e.taskId&&await M(e.taskId)},k=t=>{const e=f.value.find(s=>s.id===t);if(e){if(e.source){const n=e.source.split(",").filter(l=>l.trim());S.value=n.map((l,m)=>{const w=l.trim();return{uid:`${Date.now()}-${m}`,name:w.substring(w.lastIndexOf("/")+1),status:"done",url:w}})}else S.value=[];const s={programming:1,choice:2,kernel:4};y.value={name:e.name,source:e.source||"",require:e.require,referenceAnswer:e.referenceAnswer,difficulty:e.difficulty,tag:e.tag,classHour:e.classHour,jumpUrl:e.jumpUrl||"",type:s[e.type]||3,projectId:(g==null?void 0:g.value)||void 0,taskId:e.taskId},e.evaluationSettings?(d.value={...e.evaluationSettings},e.evaluationSettings.userFiles&&Array.isArray(e.evaluationSettings.userFiles)?_.value=e.evaluationSettings.userFiles:_.value=[],e.evaluationSettings.testValidateFiles&&Array.isArray(e.evaluationSettings.testValidateFiles)?x.value=e.evaluationSettings.testValidateFiles:x.value=[]):(d.value={timeLimitM:0,userFiles:[],testValidateFiles:[],testValidateSh:"",passType:1,blankCode:1,scoreRule:1,testValidateType:1,testContent:[]},_.value=[],x.value=[])}},r=t=>{const e=f.value.find(s=>s.id===t);if(e){const s=e.questions;e.source=y.value.source,e.require=y.value.require,e.referenceAnswer=y.value.referenceAnswer,e.difficulty=y.value.difficulty,e.tag=y.value.tag,e.classHour=y.value.classHour,e.jumpUrl=y.value.jumpUrl,y.value.taskId&&(e.taskId=y.value.taskId),e.questions=s,e.evaluationSettings={...d.value}}},q=async t=>{const{file:e,onSuccess:s,onError:n}=t;try{const l=await ce(e);s({url:l},e)}catch(l){n(l)}},v=t=>{var l;const{file:e,fileList:s}=t;e.status==="done"?i.success(`${e.name} 文件上传成功`):e.status==="error"&&i.error(`${e.name} 文件上传失败`),S.value=s.map(m=>{var w;return{uid:m.uid,name:m.name,status:m.status,url:((w=m.response)==null?void 0:w.url)||m.url||""}});const n=S.value.filter(m=>m.url).map(m=>m.url).join(",");y.value.source=n,(l=F.value)==null||l.validateFields(["source"])},A=async()=>{var t,e,s;try{if($.value||o.value)await((t=F.value)==null?void 0:t.validate());else if(u.value){if(await Promise.all([(e=F.value)==null?void 0:e.validate(),(s=c.value)==null?void 0:s.validate()]),y.value.taskId&&d.value.testValidateType===1&&d.value.testContent.length===0){i.error("用例类型为文本时，必须至少创建一条测试集");return}if(y.value.taskId&&d.value.testValidateType===1&&d.value.testContent.length>0&&d.value.testContent.find(w=>!w.arg.trim()||!w.answer.trim())){i.error("测试集的输入内容和期望输出不能为空");return}}let n={...y.value};if(u.value){const m=d.value.testContent.map(I=>({arg:I.arg,answer:I.answer,select:I.select})),w=d.value.userFiles.filter(I=>I.url).map(I=>I.url).join(","),P=d.value.testValidateFiles.filter(I=>I.url).map(I=>I.url).join(",");n={...n,timeLimitM:d.value.timeLimitM,userFiles:w,testValidateFiles:P,passType:d.value.passType,blankCode:d.value.blankCode,scoreRule:d.value.scoreRule,testValidateSh:d.value.testValidateSh,testValidateType:d.value.testValidateType,testContent:JSON.stringify(m)}}console.log("准备提交的数据:",n);let l;y.value.taskId?(l=await fe({...n,taskId:y.value.taskId}),console.log("任务关卡更新成功，返回数据:",l),i.success("更新成功")):(l=await pe(n),console.log("任务关卡创建成功，返回数据:",l),l.taskId&&(y.value.taskId=l.taskId,console.log("已保存 taskId:",l.taskId)),i.success("保存成功")),a.value&&r(a.value)}catch(n){console.error("保存任务关卡失败:",n),i.error("请完善必填信息")}},z=()=>{H.confirm({title:"确认重置",content:"确定要重置表单吗？所有未保存的数据将会丢失。",okText:"确定",cancelText:"取消",onOk:()=>{var e,s;let t=1;if(a.value){const n=f.value.find(l=>l.id===a.value);n&&(t={programming:1,choice:2,kernel:4}[n.type]||1)}y.value={name:"",source:"",require:"",referenceAnswer:"",difficulty:2,tag:"",classHour:"",jumpUrl:"",type:t,projectId:(g==null?void 0:g.value)||void 0},d.value={timeLimitM:0,userFiles:[],testValidateFiles:[],testValidateSh:"",passType:1,blankCode:1,scoreRule:1,testValidateType:1,testContent:[]},S.value=[],_.value=[],x.value=[],(e=F.value)==null||e.clearValidate(),(s=c.value)==null||s.clearValidate(),i.success("已重置")}})},G=t=>{var n;const{file:e,fileList:s}=t;e.status==="done"?i.success(`${e.name} 文件上传成功`):e.status==="error"&&i.error(`${e.name} 文件上传失败`),_.value=s.map(l=>{var m;return{uid:l.uid,name:l.name,status:l.status,url:((m=l.response)==null?void 0:m.url)||l.url||""}}),d.value.userFiles=[..._.value],(n=c.value)==null||n.validateFields(["userFiles"])},X=t=>{var n;const{file:e,fileList:s}=t;e.status==="done"?i.success(`${e.name} 文件上传成功`):e.status==="error"&&i.error(`${e.name} 文件上传失败`),x.value=s.map(l=>{var m;return{uid:l.uid,name:l.name,status:l.status,url:((m=l.response)==null?void 0:m.url)||l.url||""}}),d.value.testValidateFiles=[...x.value],(n=c.value)==null||n.validateFields(["testValidateFiles"])},Y=()=>{d.value.testContent.push({id:Date.now().toString(),arg:"",answer:"",select:1})},Z=t=>{const e=d.value.testContent.findIndex(s=>s.id===t);e!==-1&&(d.value.testContent.splice(e,1),i.success("删除成功"))},ee=()=>{d.value.testContent=[],i.success("已清空所有测试用例")},te=()=>{i.info("下载功能开发中...")},se=()=>{i.info("批量上传功能开发中...")},ae=D(()=>{if(!a.value)return[];const t=f.value.find(e=>e.id===a.value);return(t==null?void 0:t.questions)||[]}),ne=t=>{if(!a.value)return;const e=f.value.find(s=>s.id===a.value);e&&(e.questions||(e.questions=[]),e.questions.push(t),i.success("题目添加成功"))},le=async t=>{a.value&&H.confirm({title:"确认删除",content:"确定要删除这道题目吗？删除后无法恢复。",okText:"确定",cancelText:"取消",async onOk(){try{console.log("开始删除题目，ID:",t),await me({id:parseInt(t)}),console.log("题目删除成功"),i.success("题目删除成功");const e=f.value.find(s=>s.id===a.value);if(e&&e.questions){const s=e.questions.findIndex(n=>n.id===t);s!==-1&&e.questions.splice(s,1)}e&&e.taskId&&await M(e.taskId)}catch(e){console.error("题目删除失败:",e),i.error(e.message||"题目删除失败，请重试")}}})},re=t=>{if(!a.value)return;const e=f.value.find(s=>s.id===a.value);if(e&&e.questions){const s=e.questions.findIndex(n=>n.id===t.id);s!==-1&&(e.questions[s]=t,i.success("题目更新成功"))}},ie=t=>{if(!a.value)return;const e=f.value.find(s=>s.id===a.value);e&&(e.questions=t)},oe=async t=>{if(!(g!=null&&g.value))throw new Error("项目ID不存在");try{console.log("批量更新题目排序，共",t.length,"个题目");const e=t.map(s=>W({id:parseInt(s.id),name:s.name,answer:s.answer,answerKey:s.answerKey,selects:s.selects,projectId:s.projectId||g.value,taskId:s.taskId,weight:s.weight}));await Promise.all(e),console.log("题目排序保存成功")}catch(e){throw console.error("保存题目排序失败:",e),e}},M=async t=>{if(!(g!=null&&g.value)){console.error("项目ID不存在");return}try{console.log("开始加载题目列表，参数:",{projectId:g.value,taskId:t});const e=await ve({projectId:g.value,taskId:t});console.log("题目列表加载成功:",e);const s=e.map(n=>({id:n.id.toString(),name:n.name,answer:n.answer,answerKey:n.answerKey,selects:n.selects,projectId:n.projectId,taskId:n.taskId,weight:n.weight})).sort((n,l)=>(n.weight||0)-(l.weight||0));if(a.value){const n=f.value.find(l=>l.id===a.value);n&&(n.questions=s,console.log("题目列表已更新到任务关卡:",n.name,"题目数量:",s.length))}}catch(e){console.error("加载题目列表失败:",e),i.error(e.message||"加载题目列表失败")}};return{taskLevels:f,selectedTaskLevelId:a,currentTab:T,taskLevelFormRef:F,evaluationFormRef:c,taskLevelFormData:y,evaluationFormData:d,learningResourceFileList:S,taskLevelFormRules:K,evaluationFormRules:O,isKernelTask:$,isChoiceTask:o,isProgrammingTask:u,addTaskLevel:p,deleteTaskLevel:h,selectTaskLevel:b,saveTaskLevel:A,resetTaskLevel:z,handleLearningResourceCustomRequest:q,handleLearningResourceUpload:v,handleUserFilesUpload:G,handleTestValidateFilesUpload:X,userFileList:_,testValidateFileList:x,addTestCase:Y,removeTestCase:Z,clearAllTestCases:ee,downloadTemplate:te,batchUploadTestCases:se,getCurrentQuestions:ae,addQuestion:ne,deleteQuestion:le,updateQuestion:re,updateQuestionsOrder:ie,loadQuestions:M,saveQuestionsOrder:oe}}export{Oe as Q,Me as u};
