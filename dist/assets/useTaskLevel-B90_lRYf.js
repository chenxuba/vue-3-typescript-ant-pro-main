import{R as ue,u as ce}from"./RichTextEditor-BSi79UJu.js";import{h as Y,i as de,j as ve,k as me,l as fe,m as pe,b as ge,d as ye}from"./index-9HtY5iSt.js";import{K as he,z as we,H as ke,I as Ce,ag as Ie,a6 as be,ah as Te,ad as o,M as G}from"./antd-C8FlOT2N.js";import{d as Fe,f as k,w as _e,a6 as z,a1 as K,a7 as _,k as A,$ as U,G as $,_ as J,F as Ae,ag as qe,ac as W,ab as xe,a9 as Se,u as X,c as M}from"./vue-PnzzEkKE.js";import{_ as Ve}from"./index-C3OFe7rM.js";const Le={class:"ai-buttons-bar"},Re={class:"options-list"},Qe=["onClick"],Ke=Fe({__name:"QuestionModal",props:{open:{type:Boolean},question:{},projectId:{},taskId:{},existingQuestions:{}},emits:["update:open","confirm"],setup(y,{emit:p}){const n=y,b=p,T=k(),i=k({id:"",name:"",options:[{id:"1",label:"A",content:"",isCorrect:!1},{id:"2",label:"B",content:"",isCorrect:!1},{id:"3",label:"C",content:"",isCorrect:!1},{id:"4",label:"D",content:"",isCorrect:!1}],answerKey:""}),V={name:[{required:!0,message:"请输入题干"},{validator:(c,s)=>!s||!s.replace(/<[^>]*>/g,"").trim()?Promise.reject("请输入内容"):Promise.resolve()}],answerKey:[{required:!0,message:"请输入答案解析",trigger:"blur"}]},d=c=>{let s=[];try{s=JSON.parse(c.selects||"[]").map((g,C)=>{const I=Object.keys(g)[0];return{id:(C+1).toString(),label:I,content:g[I],isCorrect:c.answer.includes(I)}})}catch{s=[{id:"1",label:"A",content:"",isCorrect:!1},{id:"2",label:"B",content:"",isCorrect:!1},{id:"3",label:"C",content:"",isCorrect:!1},{id:"4",label:"D",content:"",isCorrect:!1}]}return{id:c.id,name:c.name,options:s,answerKey:c.answerKey}};_e(()=>n.open,c=>{c&&(n.question?i.value=d(n.question):i.value={id:Date.now().toString(),name:"",options:[{id:"1",label:"A",content:"",isCorrect:!1},{id:"2",label:"B",content:"",isCorrect:!1},{id:"3",label:"C",content:"",isCorrect:!1},{id:"4",label:"D",content:"",isCorrect:!1}],answerKey:""})});const q=()=>{var c;b("update:open",!1),(c=T.value)==null||c.resetFields()},S=c=>{var C,I;const s=c.options.filter(u=>u.content.trim()).map(u=>({[u.label]:u.content})),v=c.options.filter(u=>u.isCorrect).map(u=>u.label).join(",");let g=1;return n.question&&n.question.weight?g=n.question.weight:n.existingQuestions&&n.existingQuestions.length>0&&(g=Math.max(...n.existingQuestions.map(x=>x.weight||0))+1),{id:c.id,name:c.name,answer:v,answerKey:c.answerKey,selects:JSON.stringify(s),projectId:n.projectId||((C=n.question)==null?void 0:C.projectId),taskId:n.taskId||((I=n.question)==null?void 0:I.taskId),weight:g}},D=async()=>{var c,s,v,g;try{if(await((c=T.value)==null?void 0:c.validate()),!i.value.options.some(m=>m.content.trim())){o.error("请至少填写一个选项");return}if(!i.value.options.some(m=>m.isCorrect)){o.error("请至少设置一个正确答案");return}if(!n.projectId){o.error("项目ID不存在");return}if(!n.taskId){o.error("任务关卡ID不存在，请先保存任务关卡");return}const u=S(i.value),x=n.question&&n.question.id;console.log("=== 题目参数 ==="),console.log("操作模式:",x?"编辑":"新增"),console.log("题目ID (id):",u.id),console.log("题目数据:",u),console.log("项目ID (projectId):",u.projectId),console.log("任务ID (taskId):",u.taskId),console.log("排序权重 (weight):",u.weight),console.log("已有题目数量:",((s=n.existingQuestions)==null?void 0:s.length)||0),console.log("==================");try{if(x){console.log("编辑模式：调用更新接口");const m=await Y({id:parseInt(u.id),name:u.name,answer:u.answer,answerKey:u.answerKey,selects:u.selects,projectId:u.projectId,taskId:u.taskId,weight:u.weight});console.log("题目更新成功，返回数据:",m),o.success("题目更新成功"),b("confirm",u),b("update:open",!1),(v=T.value)==null||v.resetFields()}else{const m=await de({name:u.name,answer:u.answer,answerKey:u.answerKey,selects:u.selects,projectId:u.projectId,taskId:u.taskId,weight:u.weight});console.log("题目创建成功，返回数据:",m),o.success("题目创建成功"),u.id=m.id.toString(),b("confirm",u),b("update:open",!1),(g=T.value)==null||g.resetFields()}}catch(m){console.error(x?"题目更新失败:":"题目创建失败:",m),o.error(m.message||(x?"题目更新失败，请重试":"题目创建失败，请重试"))}}catch{o.error("请完善必填信息")}},P=c=>{i.value.options.forEach(v=>{v.isCorrect=!1});const s=i.value.options.find(v=>v.id===c);s&&(s.isCorrect=!0)},j=c=>{if(i.value.options.length<=2){o.warning("至少保留2个选项");return}const s=i.value.options.findIndex(v=>v.id===c);s!==-1&&(i.value.options.splice(s,1),i.value.options.forEach((v,g)=>{v.label=String.fromCharCode(65+g)}))},O=()=>{if(i.value.options.length>=10){o.warning("最多添加10个选项");return}const c=String.fromCharCode(65+i.value.options.length);i.value.options.push({id:Date.now().toString(),label:c,content:"",isCorrect:!1})},R=k(!1),L=k(!1),E=async()=>{if(!i.value.name){o.warning("请先输入题干内容");return}if(!i.value.name.replace(/<[^>]*>/g,"").trim()){o.warning("请先输入题干内容");return}try{L.value=!0,o.loading("AI正在润色题干，请稍候...",0);const s=await ve(i.value.name);o.destroy(),i.value.name=s,o.success("AI润色成功")}catch(s){o.destroy(),console.error("AI润色失败:",s),o.error(s.message||"AI润色失败，请重试")}finally{L.value=!1}},B=async()=>{if(!i.value.name){o.warning("请先输入题干内容");return}if(!i.value.name.replace(/<[^>]*>/g,"").trim()){o.warning("请先输入题干内容");return}try{R.value=!0,o.loading("AI正在生成题目，请稍候...",0);const s=await me(i.value.name);if(o.destroy(),console.log("=== AI出题返回数据 ==="),console.log("返回结果:",s),s.title&&(i.value.name=s.title),s.options&&Array.isArray(s.options)&&s.options.length>0){const v=s.options.map((g,C)=>{const I=String.fromCharCode(65+C);return{id:(C+1).toString(),label:I,content:g,isCorrect:!1}});i.value.options=v}if(s.answer){const v=s.answer.split(",").map(g=>g.trim());i.value.options.forEach(g=>{g.isCorrect=v.includes(g.label)})}s.analysis&&(i.value.answerKey=s.analysis),o.success("AI出题成功")}catch(s){o.destroy(),console.error("AI出题失败:",s),o.error(s.message||"AI出题失败，请重试")}finally{R.value=!1}};return(c,s)=>{const v=ke,g=we,C=Ce,I=Te,u=he,x=G;return K(),z(x,{open:c.open,title:c.question?"编辑题目":"添加题目",width:"900px","mask-closable":!1,onCancel:q},{footer:_(()=>[A(v,{onClick:q},{default:_(()=>s[5]||(s[5]=[$("取消")])),_:1,__:[5]}),A(v,{type:"primary",onClick:D},{default:_(()=>s[6]||(s[6]=[$("保存")])),_:1,__:[6]})]),default:_(()=>[A(u,{ref_key:"formRef",ref:T,model:i.value,rules:V,layout:"vertical"},{default:_(()=>[A(g,{label:"题干",name:"name",required:""},{default:_(()=>[U("div",Le,[A(v,{type:"primary",onClick:B,loading:R.value,size:"small"},{default:_(()=>s[2]||(s[2]=[$(" AI出题 ")])),_:1,__:[2]},8,["loading"]),A(v,{type:"primary",onClick:E,loading:L.value,size:"small"},{default:_(()=>s[3]||(s[3]=[$(" AI润色 ")])),_:1,__:[3]},8,["loading"])]),A(ue,{modelValue:i.value.name,"onUpdate:modelValue":s[0]||(s[0]=m=>i.value.name=m),placeholder:"请您输入题干",height:150,"show-ai-embellish":!1},null,8,["modelValue"])]),_:1}),A(g,{required:""},{label:_(()=>s[4]||(s[4]=[U("span",null,[$("答案选项 "),U("span",{class:"options-hint ml-12px"},"点击字母设置正确答案（单选）")],-1)])),default:_(()=>[U("div",Re,[(K(!0),J(Ae,null,qe(i.value.options,m=>(K(),J("div",{key:m.id,class:"option-item"},[U("div",{class:xe(["option-label",{"is-correct":m.isCorrect}]),onClick:Q=>P(m.id)},Se(m.label),11,Qe),A(C,{value:m.content,"onUpdate:value":Q=>m.content=Q,placeholder:"请输入选项内容",class:"option-input"},null,8,["value","onUpdate:value"]),i.value.options.length>2?(K(),z(X(Ie),{key:0,class:"remove-icon",onClick:Q=>j(m.id)},null,8,["onClick"])):W("",!0),m.id===i.value.options[i.value.options.length-1].id&&i.value.options.length<10?(K(),z(X(be),{key:1,class:"add-icon",onClick:O})):W("",!0)]))),128))])]),_:1}),A(g,{label:"答案解析",name:"answerKey",required:""},{default:_(()=>[A(I,{value:i.value.answerKey,"onUpdate:value":s[1]||(s[1]=m=>i.value.answerKey=m),placeholder:"请输入答案解析",rows:1},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","title"])}}}),Pe=Ve(Ke,[["__scopeId","data-v-403b19b6"]]);function je(y){const p=k([]),n=k(""),b=k("task"),T=k(),i=k(),h=k({name:"",source:"",require:"",referenceAnswer:"",difficulty:2,tag:"",classHour:"",jumpUrl:"",type:1,projectId:(y==null?void 0:y.value)||void 0}),V=k([]),d=k({timeLimitM:0,userFiles:[],testValidateFiles:[],testValidateSh:"",passType:1,passTypeRule:"",blankCode:1,scoreRule:1,testValidateType:1,testContent:[]}),q=k([]),S=k([]),D=(t,e)=>!e||!e.replace(/<[^>]*>/g,"").trim()?Promise.reject("请输入内容"):Promise.resolve(),P={name:[{required:!0,message:"请输入任务名称",trigger:"blur"}],source:[{required:!0,message:"请上传学习资源",trigger:"change"}],require:[{required:!0,message:""},{validator:D}],referenceAnswer:[{required:!0,message:""},{validator:D}],difficulty:[{required:!0,message:"请选择难度系数",trigger:"change"}],tag:[{required:!0,message:"请输入技能标签",trigger:"blur"}],classHour:[{required:!0,message:"请输入任务学时",trigger:"blur"}],jumpUrl:[{required:!0,message:"请输入内嵌链接",trigger:"blur"}]},j={timeLimitM:[{required:!0,message:"请输入评测时长限制",trigger:"blur"}],userFiles:[{required:!0,message:"请上传学员任务文件",trigger:"change",type:"array",min:1}],testValidateFiles:[{required:!0,message:"请上传评测执行文件",trigger:"change",type:"array",min:1}],testValidateSh:[{required:!0,message:"请输入评测执行命令",trigger:"blur"}]},O=M(()=>{if(!n.value)return!1;const t=p.value.find(e=>e.id===n.value);return(t==null?void 0:t.type)==="kernel"}),R=M(()=>{if(!n.value)return!1;const t=p.value.find(e=>e.id===n.value);return(t==null?void 0:t.type)==="choice"}),L=M(()=>{if(!n.value)return!1;const t=p.value.find(e=>e.id===n.value);return(t==null?void 0:t.type)==="programming"}),E=t=>{if(p.value.some(r=>!r.taskId)){o.warning("请先保存当前未保存的任务关卡，再添加新关卡");return}if(n.value){const r=p.value.find(f=>f.id===n.value);if(r&&r.taskId){if(r.type==="choice"&&(!r.questions||r.questions.length===0)){o.warning("请至少新增一条题目"),b.value="questions";return}if(r.type==="programming"&&(!r.evaluationSettings||!r.evaluationSettings.testContent||r.evaluationSettings.testContent.length===0)){o.warning("请先配置评测设置后再添加新关卡"),b.value="evaluation";return}}}const a={programming:"编程实训任务关卡",choice:"选择题实训任务关卡",kernel:"内核链接实训任务关卡"},l={id:Date.now().toString(),name:`第${p.value.length+1}关：${a[t]}`,type:t,source:"",require:"",referenceAnswer:"",difficulty:2,tag:"",classHour:""};p.value.push(l),n.value=l.id,b.value="task",s(l.id),o.success("任务关卡添加成功")},B=t=>{var a;const e=p.value.findIndex(l=>l.id===t);e!==-1&&(p.value.splice(e,1),p.value.forEach((l,r)=>{const f=l.name.match(/^第\d+关：(.+)$/);if(f)l.name=`第${r+1}关：${f[1]}`;else{const w=l.name.indexOf("：");if(w!==-1){const N=l.name.substring(w+1);l.name=`第${r+1}关：${N}`}else l.name=`第${r+1}关：${l.name}`}}),n.value===t&&(n.value=((a=p.value[0])==null?void 0:a.id)||""),n.value&&s(n.value),o.success("任务关卡删除成功"))},c=async t=>{n.value&&n.value!==t&&v(n.value),n.value=t,b.value="task",s(t);const e=p.value.find(a=>a.id===t);e&&e.type==="choice"&&e.taskId&&await H(e.taskId)},s=t=>{const e=p.value.find(a=>a.id===t);if(e){if(e.source){const l=e.source.split(",").filter(r=>r.trim());V.value=l.map((r,f)=>{const w=r.trim();return{uid:`${Date.now()}-${f}`,name:w.substring(w.lastIndexOf("/")+1),status:"done",url:w}})}else V.value=[];const a={programming:1,choice:2,kernel:4};h.value={name:e.name,source:e.source||"",require:e.require,referenceAnswer:e.referenceAnswer,difficulty:e.difficulty,tag:e.tag,classHour:e.classHour,jumpUrl:e.jumpUrl||"",type:a[e.type]||3,projectId:(y==null?void 0:y.value)||void 0,taskId:e.taskId},e.evaluationSettings?(d.value={...e.evaluationSettings},e.evaluationSettings.userFiles&&Array.isArray(e.evaluationSettings.userFiles)?q.value=e.evaluationSettings.userFiles:q.value=[],e.evaluationSettings.testValidateFiles&&Array.isArray(e.evaluationSettings.testValidateFiles)?S.value=e.evaluationSettings.testValidateFiles:S.value=[]):(d.value={timeLimitM:0,userFiles:[],testValidateFiles:[],testValidateSh:"",passType:1,passTypeRule:"",blankCode:1,scoreRule:1,testValidateType:1,testContent:[]},q.value=[],S.value=[])}},v=t=>{const e=p.value.find(a=>a.id===t);if(e){const a=e.questions;e.source=h.value.source,e.require=h.value.require,e.referenceAnswer=h.value.referenceAnswer,e.difficulty=h.value.difficulty,e.tag=h.value.tag,e.classHour=h.value.classHour,e.jumpUrl=h.value.jumpUrl,h.value.taskId&&(e.taskId=h.value.taskId),e.questions=a,e.evaluationSettings={...d.value}}},g=async t=>{const{file:e,onSuccess:a,onError:l}=t;try{const r=await ce(e);a({url:r},e)}catch(r){l(r)}},C=t=>{var r;const{file:e,fileList:a}=t;e.status==="done"?o.success(`${e.name} 文件上传成功`):e.status==="error"&&o.error(`${e.name} 文件上传失败`),V.value=a.map(f=>{var w;return{uid:f.uid,name:f.name,status:f.status,url:((w=f.response)==null?void 0:w.url)||f.url||""}});const l=V.value.filter(f=>f.url).map(f=>f.url).join(",");h.value.source=l,(r=T.value)==null||r.validateFields(["source"])},I=async()=>{var t,e,a;try{if(O.value||R.value)await((t=T.value)==null?void 0:t.validate());else if(L.value){if(await Promise.all([(e=T.value)==null?void 0:e.validate(),(a=i.value)==null?void 0:a.validate()]),h.value.taskId&&d.value.testValidateType===1&&d.value.testContent.length===0){o.error("用例类型为文本时，必须至少创建一条测试集");return}if(h.value.taskId&&d.value.testValidateType===1&&d.value.testContent.length>0&&d.value.testContent.find(w=>!w.arg.trim()||!w.answer.trim())){o.error("测试集的输入内容和期望输出不能为空");return}}let l={...h.value};if(L.value){const f=d.value.testContent.map(F=>({arg:F.arg,answer:F.answer,select:F.select})),w=d.value.userFiles.filter(F=>F.url).map(F=>F.url).join(","),N=d.value.testValidateFiles.filter(F=>F.url).map(F=>F.url).join(",");l={...l,timeLimitM:d.value.timeLimitM,userFiles:w,testValidateFiles:N,passType:d.value.passType,passTypeRule:d.value.passTypeRule,blankCode:d.value.blankCode,scoreRule:d.value.scoreRule,testValidateSh:d.value.testValidateSh,testValidateType:d.value.testValidateType,testContent:JSON.stringify(f)}}console.log("准备提交的数据:",l);let r;h.value.taskId?(r=await ge({...l,taskId:h.value.taskId}),console.log("任务关卡更新成功，返回数据:",r),o.success("更新成功")):(r=await ye(l),console.log("任务关卡创建成功，返回数据:",r),r.taskId&&(h.value.taskId=r.taskId,console.log("已保存 taskId:",r.taskId)),o.success("保存成功")),n.value&&v(n.value)}catch(l){console.error("保存任务关卡失败:",l),o.error("请完善必填信息")}},u=()=>{G.confirm({title:"确认重置",content:"确定要重置表单吗？所有未保存的数据将会丢失。",okText:"确定",cancelText:"取消",onOk:()=>{var e,a;let t=1;if(n.value){const l=p.value.find(r=>r.id===n.value);l&&(t={programming:1,choice:2,kernel:4}[l.type]||1)}h.value={name:"",source:"",require:"",referenceAnswer:"",difficulty:2,tag:"",classHour:"",jumpUrl:"",type:t,projectId:(y==null?void 0:y.value)||void 0},d.value={timeLimitM:0,userFiles:[],testValidateFiles:[],testValidateSh:"",passType:1,passTypeRule:"",blankCode:1,scoreRule:1,testValidateType:1,testContent:[]},V.value=[],q.value=[],S.value=[],(e=T.value)==null||e.clearValidate(),(a=i.value)==null||a.clearValidate(),o.success("已重置")}})},x=t=>{var l;const{file:e,fileList:a}=t;e.status==="done"?o.success(`${e.name} 文件上传成功`):e.status==="error"&&o.error(`${e.name} 文件上传失败`),q.value=a.map(r=>{var f;return{uid:r.uid,name:r.name,status:r.status,url:((f=r.response)==null?void 0:f.url)||r.url||""}}),d.value.userFiles=[...q.value],(l=i.value)==null||l.validateFields(["userFiles"])},m=t=>{var l;const{file:e,fileList:a}=t;e.status==="done"?o.success(`${e.name} 文件上传成功`):e.status==="error"&&o.error(`${e.name} 文件上传失败`),S.value=a.map(r=>{var f;return{uid:r.uid,name:r.name,status:r.status,url:((f=r.response)==null?void 0:f.url)||r.url||""}}),d.value.testValidateFiles=[...S.value],(l=i.value)==null||l.validateFields(["testValidateFiles"])},Q=()=>{d.value.testContent.push({id:Date.now().toString(),arg:"",answer:"",select:1})},Z=t=>{const e=d.value.testContent.findIndex(a=>a.id===t);e!==-1&&(d.value.testContent.splice(e,1),o.success("删除成功"))},ee=()=>{d.value.testContent=[],o.success("已清空所有测试用例")},te=()=>{o.info("下载功能开发中...")},se=()=>{o.info("批量上传功能开发中...")},ae=M(()=>{if(!n.value)return[];const t=p.value.find(e=>e.id===n.value);return(t==null?void 0:t.questions)||[]}),ne=t=>{if(!n.value)return;const e=p.value.find(a=>a.id===n.value);e&&(e.questions||(e.questions=[]),e.questions.push(t),o.success("题目添加成功"))},le=async t=>{n.value&&G.confirm({title:"确认删除",content:"确定要删除这道题目吗？删除后无法恢复。",okText:"确定",cancelText:"取消",async onOk(){try{console.log("开始删除题目，ID:",t),await pe({id:parseInt(t)}),console.log("题目删除成功"),o.success("题目删除成功");const e=p.value.find(a=>a.id===n.value);if(e&&e.questions){const a=e.questions.findIndex(l=>l.id===t);a!==-1&&e.questions.splice(a,1)}e&&e.taskId&&await H(e.taskId)}catch(e){console.error("题目删除失败:",e),o.error(e.message||"题目删除失败，请重试")}}})},re=t=>{if(!n.value)return;const e=p.value.find(a=>a.id===n.value);if(e&&e.questions){const a=e.questions.findIndex(l=>l.id===t.id);a!==-1&&(e.questions[a]=t,o.success("题目更新成功"))}},oe=t=>{if(!n.value)return;const e=p.value.find(a=>a.id===n.value);e&&(e.questions=t)},ie=async t=>{if(!(y!=null&&y.value))throw new Error("项目ID不存在");try{console.log("批量更新题目排序，共",t.length,"个题目");const e=t.map(a=>Y({id:parseInt(a.id),name:a.name,answer:a.answer,answerKey:a.answerKey,selects:a.selects,projectId:a.projectId||y.value,taskId:a.taskId,weight:a.weight}));await Promise.all(e),console.log("题目排序保存成功")}catch(e){throw console.error("保存题目排序失败:",e),e}},H=async t=>{if(!(y!=null&&y.value)){console.error("项目ID不存在");return}try{console.log("开始加载题目列表，参数:",{projectId:y.value,taskId:t});const e=await fe({projectId:y.value,taskId:t});console.log("题目列表加载成功:",e);const a=e.map(l=>({id:l.id.toString(),name:l.name,answer:l.answer,answerKey:l.answerKey,selects:l.selects,projectId:l.projectId,taskId:l.taskId,weight:l.weight})).sort((l,r)=>(l.weight||0)-(r.weight||0));if(n.value){const l=p.value.find(r=>r.id===n.value);l&&(l.questions=a,console.log("题目列表已更新到任务关卡:",l.name,"题目数量:",a.length))}}catch(e){console.error("加载题目列表失败:",e),o.error(e.message||"加载题目列表失败")}};return{taskLevels:p,selectedTaskLevelId:n,currentTab:b,taskLevelFormRef:T,evaluationFormRef:i,taskLevelFormData:h,evaluationFormData:d,learningResourceFileList:V,taskLevelFormRules:P,evaluationFormRules:j,isKernelTask:O,isChoiceTask:R,isProgrammingTask:L,addTaskLevel:E,deleteTaskLevel:B,selectTaskLevel:c,saveTaskLevel:I,resetTaskLevel:u,handleLearningResourceCustomRequest:g,handleLearningResourceUpload:C,handleUserFilesUpload:x,handleTestValidateFilesUpload:m,userFileList:q,testValidateFileList:S,addTestCase:Q,removeTestCase:Z,clearAllTestCases:ee,downloadTemplate:te,batchUploadTestCases:se,getCurrentQuestions:ae,addQuestion:ne,deleteQuestion:le,updateQuestion:re,updateQuestionsOrder:oe,loadQuestions:H,saveQuestionsOrder:ie}}export{Pe as Q,je as u};
